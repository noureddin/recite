<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>راجع ما تحفظ من القرآن الكريم | رسايت</title>
<meta name="description" content="تطبيق ويب مجاني لمراجعة حفظ القرآن الكريم بدون كتابة. للحاسوب والمحمول.">
<link rel="canonical" href="https://noureddin.github.io/recite/">
<meta property="og:locale" content="ar_AR">
<meta property="og:type" content="website">
<meta property="og:title" content="راجع ما تحفظ من القرآن الكريم | رسايت">
<meta property="og:description" content="تطبيق ويب مجاني لمراجعة حفظ القرآن الكريم بدون كتابة. للحاسوب والمحمول.">
<meta property="og:image" content="./og-image.png">
<meta property="og:url" content="https://noureddin.github.io/recite/">
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://noureddin.github.io/recite/">
<meta property="twitter:image" content="./twitter-image.png">

<style>
/* Amiri Quran and Amiri Quran Colored 0.112, SIL OFL 1.1; https://github.com/alif-type/amiri */
@font-face {
  font-family: AmiriQuranWeb;
  font-style: normal;
  font-weight: 400;
  src: url('woff/AmiriQuran.woff2') format('woff2'),
       url('woff/AmiriQuran.woff')  format('woff');
}

@font-face {
  font-family: AmiriQuranColoredWeb;
  font-style: normal;
  font-weight: 400;
  src: url('woff/AmiriQuranColored.woff2') format('woff2'),
       url('woff/AmiriQuranColored.woff')  format('woff');
}

/* The following two fonts are from: https://sourceforge.net/projects/arabeyes/files/Fonts/ */
/* They are under GNU GPL v2. Both are converted from TrueType to WOFF using */
/* the WOFFjs-based WOFFer at: https://andrewsun.com/tools/woffer-woff-font-converter/ */
/* and to WOFF2 using: https://everythingfonts.com/ttf-to-woff2 */
@font-face {
  font-family: KacstOne; /* version 5.0 */
  font-style: normal;
  font-weight: 400;
  src: url('woff/KacstOne.woff2') format('woff2'),
       url('woff/KacstOne.woff')  format('woff');
}
@font-face {
  font-family: Cortoba;  /* version 2.1 */
  font-style: normal;
  font-weight: 400;
  src: url('woff/ae_Cortoba.woff2') format('woff2'),
       url('woff/ae_Cortoba.woff')  format('woff');
}

/* general */
html, body {
  padding: 0;
  margin: 0;
  overflow: hidden;
  --all-width: clamp(10rem, 80vw, 35rem);
}

body {
  text-align: center; /* center everything */

}
#body {
  background-color: var(--background);
  height: 100vh;
  width: 100vw;
  direction: rtl;
  overflow-y: scroll;
  overflow-x: hidden;
  box-sizing: border-box;
}
#all {
  display: inline-block;
  width: var(--all-width);
}

#body {
  /* general */
  --btn-base-width: min(35vw, 10rem);
  --faint-btn: #666;
  --uitext: #233; --txt: #111;
  --txt-font: AmiriQuranWeb;
  --background-rgb: 249, 246, 231; /* old: 249, 244, 214; */
  --content-rgb:    252, 250, 241;
  --background: rgb(var(--background-rgb));
  --background-translucent: rgba(var(--background-rgb), 0.66);
  --details-bg: white; --details-shadow: black;
  --title-rgb: 0, 0, 0;
  /* tajweed */
  --L: #bb6666; --W: red;     --J: orangered; --T: #ff9900;    --N: #009000;
  --X: #9595a0; --R: #2222e0; --Q: #00a5e7;   --A: darkorange; --D: navy;
  /* ayat number color */
  --A-shadow: 1px  1px  1px gold,
              1px -1px  1px gold,
             -1px  1px  1px gold,
             -1px -1px  1px gold,
              0    0    5px blue;
  --D-shadow: 0 0 10px rgba(0, 0, 255, 0.5);
  /* help & options : tab label */
  --tab-txt: #000;
  --tab-active-txt: var(--tab-txt);
  --tab: gold;
  --tab-active: yellow;
}

#dark:checked ~ #body {
  /* general */
  --faint-btn: #555;
  --uitext: #ccc;  --txt: #eee;  --background-rgb: 13, 13, 13; --content-rgb: 23, 23, 23;
  --details-bg: black; --details-shadow: white;
  --title-rgb: 255, 255, 255;
  /* tajweed */
  --L: #bb5555;  --W: red    ;  --J: #ff6600;  --T: #ffbb00;  --N: #00ff00;
  --X: #808080;  --R: #4477ff;  --Q: #00d6ff;  --A: #ff8c00;  --D: #ffffff;
  /* ayat number color */
  /* --A: #ff8c00; --D: #ffffff; */
  /* help & options : tab label */
  --tab-txt: #ddb;
  --tab-active-txt: white;
  --tab: #A1761B;  /* a very dark goldenrod; from: https://colorcodes.io/yellow/goldenrod-color-codes/ */
  --tab-active: darkgoldenrod;
}

:not(input, button, select) { color: var(--uitext); } /* are just inverted */
#uthm_txt { color: var(--txt); }

.L { color: var(--L) } .W { color: var(--W) } .J { color: var(--J) } .T { color: var(--T) }
.N { color: var(--N) } .X { color: var(--X) } .R { color: var(--R) } .Q { color: var(--Q) }
.A { color: var(--A); text-shadow: var(--A-shadow) }
.D { color: var(--D); text-shadow: var(--D-shadow) }

/* general */
#body { scroll-behavior: smooth; }
::selection { background: rgba(0,0,255,0.1); }

/* https://bits.theorem.co/css-pro-tips-responsive-font-sizes-and-when-to-use-which-units */
html { font-size: calc(16px + 0.5vw) }

* {
  font-family: Cortoba;
  font-size: inherit; /* some widgets default to another value */
}

#uthm_txt, #uthm_txt * { font-family: var(--txt-font); font-size: 1.5rem; }
#uthm_txt {
  text-align: right;
  padding: 0 1em;
  padding-bottom: 4rem;
}
#endmsg {
  font-size: min(5vw, 2rem);
  text-align: center;
  color: var(--uitext);
  margin: auto;
  /* margin-top: -3rem;  /1* counter padding-bottom for #txt *1/ */
  /* the negative margin-top is commented out because I find it better to have
   * more space between #txt and #endmsg, especially after making #endmsg show
   * with the last word, not after it. */
  padding-bottom: 1rem;
}

#selectors,
#header {
  padding: 0;
  padding-top: 0.5rem;
  position: var(--sticky);  /* static (default) in imlaai; sticky in uthmani */
  background-color: var(--background-translucent);
  top:        -4.8rem;
  margin-top: -5.1rem;
  padding-top: 5.1rem;
  z-index: 2;
}

#title {
  display: none;
  margin-top: 0;
  margin-bottom: 0.5rem;
  color: rgb(var(--title-rgb));
  position: relative; z-index: 3;  /* above #header */
  font-family: KacstOne;
  font-size: clamp(0.5rem, 3.5vw, 1.25rem);
}

/* To keep #header in place, covering the area under the curve (of the tab labels) */
/* I want to make sure its height is 1em, so it's either one line, or two lines with size 0.5em */
/* I used KacstOne. The longest sura name in that font is sura 29. The longest "aaya" is the last one: "الأخيرة" */
/* I also don't want to make it too small if the title is short; hence the adaptive font-size to content. */

#title.manymany { font-size: clamp(0.5rem, 2.8vw, 1.25rem) } /* "تسميع من سورة العنكبوت الآية الأخيرة حتى سورة العنكبوت الآية الأخيرة" */


#aaya_bgn, #aaya_end { font-family: KacstOne; }

/* suar/ayat selection */
#selectors > div label:first-child { /* من سورة and إلى سورة */
  display: inline-block;
  width: 4em;
}
#selectors > div {
  display: inline-block;
  max-width: 15em;
  min-width: 40%;
  margin: 0.1rem 0;
}
#aaya_bgn, #aaya_end { width: 1.5em; }
/* #sura_bgn, #sura_end { width: 6.5em; } */
#sura_bgn, #sura_end { width: 35%; }

#options .option { margin-top: 0.5em; }
#options .option:first-child { margin-top: 1.5em; }

#options .mode_options_title {
  display: block;
  text-align: right;
  padding-right: 2em;
  margin-top: 0.3em;
  font-family: Cortoba;
  font-weight: normal;
}

#guide { display: none }  /* used for debugging */

/* #options * { margin-top: 0 !important } */
/* .mode_options_title { display: none !important } */
/* #guide { */
/*   display: block; */
/*   width: 0; */
/*   height: 10rem; */
/*   color: red; */
/*   position: absolute; */
/*   top: 0; */
/*   left: 15%; */
/* } */

#options {
  /* text-align: right; */
  padding: 0.5em 1em;
  box-sizing: border-box;
  width: var(--all-width);
}

#options * {
  font-family: KacstOne, serif;  /* serif for latin, like in qaris */
  font-weight: bold;
  line-height: 1.7;
}

.option > * { margin: 0 }
/* to make no unclickable space between the label and input. */

#darkmode_option { width: 7em }
#teacher_option { width: 14em }

.option.optionally-inline {
  display: inline-block;
  margin: 0 1em;
}

#mode_options {
  padding: 0; margin: 0;
}

#qaris         { width: calc(100% -  6.80em) }
#quizmode      { width: calc(100% -  7.35em) }
#mvbtns_input  { width: calc(100% -  9.40em) }
#textclr_input { width: calc(100% -  6.45em) }
#feedbackrate  { width: calc(100% -  9.25em) }

#imla_txt { background: var(--background); color: var(--txt) }

                      #imla_txt.done  { background: lightgreen }
                      #imla_txt.wrong { background: pink }
#dark:checked ~ #body #imla_txt.done  { background: #004400 }
#dark:checked ~ #body #imla_txt.wrong { background: #441014 }

#imla_txt {
  font-size: 1.5rem;
  text-align: right;
  padding: 0 1em;
  font-family: AmiriQuranWeb;
  line-height: 1.7;  /* Amiri Quran is too high to make space for Quranic signs */
  width: min(90%, 70vw);
  /* height: 95vh; */ /* set thru JS */
  margin: auto;
  margin-bottom: 0.5rem;
  border-radius: 0.25rem;
}

button {
  --width: var(--btn-base-width);
  width: var(--width);
  transition: opacity 0.5s ease-in-out;
  touch-action: manipulation; /* disable double-tap zooming; https://stackoverflow.com/a/53236027 */
}

#mvbtns button {
  --width: calc(var(--all-width) / 7.5);
  margin: 0;
  fill: var(--faint-btn);
}

#mvbtns #nextword {
  /* --width: calc(0.50 * var(--btn-base-width)); */
  width: calc(2*var(--width));
  fill: #000;  /* inverted in darkmode; thus becomes #fff */
}

#mvbtns svg { width: 1em; height: 1em; }

button, select, input, input[type=checkbox] + label {
  cursor: pointer;
}

button:disabled {
  cursor: not-allowed;
}

#dark:checked ~ #body kbd,
#dark:checked ~ #body input,
#dark:checked ~ #body button,
#dark:checked ~ #body select { filter: invert(1) hue-rotate(180deg) }

body.letter-parts #uthm_txt {
  --txt-font: AmiriQuranColoredWeb;
  --L: var(--txt); --W: var(--txt); --J: var(--txt); --T: var(--txt);
  --N: var(--txt); --X: var(--txt); --R: var(--txt); --Q: var(--txt);
}

body.letter-nocolor #uthm_txt {
  --L: var(--txt); --W: var(--txt); --J: var(--txt); --T: var(--txt);
  --N: var(--txt); --X: var(--txt); --R: var(--txt); --Q: var(--txt);
}

body.ayat-nocolor #uthm_txt {
  --A: var(--txt); --A-shadow: none;
  --D: var(--txt); --D-shadow: none;
}

body.letter-parts:not(.ayat-nocolor) #uthm_txt .A,
body.letter-parts:not(.ayat-nocolor) #uthm_txt .D {
  font-family: AmiriQuranWeb;
}

/* all help elements are affected by invert and hue-rotate */
#dark:checked ~ #body .help-part      { color: #f66 }
#dark:checked ~ #body summary::marker { color: #f66 }
/* #dark:checked ~ #body .help-part      { color: #f22 } */
/* #dark:checked ~ #body summary::marker { color: #f22 } */
#dark:checked ~ #body details *       { color: #aaf }
#dark:checked ~ #body strong          { color: #caf }
#dark:checked ~ #body a               { color: #bbf }
#dark:checked ~ #body kbd             { color: #000 }  /* inverted */
#dark:checked ~ #body summary         { color: #fff }

a * { color: inherit !important }

.help-part {
    font-weight: normal;
    color: #c00;
    font-size: 120%;
}
.help-part::after  { content: " :."; }
.help-part::before { content: ".: "; }

details * {
  font-family: KacstOne;
  color: #008;
}

summary {
  color: #000;
  margin-right: -0.2em;
}

details strong {
  border-bottom: 0.1em solid
}

summary::marker { color: #c00; }

#mvbtns {
  position: fixed;
  bottom: 1rem;
  height: 2em;
  /* right: calc(50vw - 0.5 * var(--mvbtns-width)); */
  right: calc(50vw - var(--all-width) / 2);
  margin: 0;
  transition: opacity 0.1s ease-in-out;
  z-index: 1;
}

@media (max-width: 432px) { #mvbtns:not(.sidebtns) { right: calc(50vw - var(--all-width) / 1.95) } }
@media (max-width: 324px) { #mvbtns:not(.sidebtns) { right: calc(50vw - var(--all-width) / 1.9) } }

#mvbtns.sidebtns {
  --btn-base-width: min(35vh, 10rem);
  --all-width: clamp(10rem, 80vh, 35rem);
  position: fixed;
  width: 100vh;
  margin: 0;
  top: 0;
  transform-origin: top right;
  transform: rotate(-90deg);
  z-index: 11;
}

#mvbtns.sidebtns.rightside {
  right: calc(0.25 * var(--btn-base-width));
}

#mvbtns.sidebtns.leftside {
  right: calc(100vw - 0.05 * var(--btn-base-width));
}

#ok {
  display: block;
  margin: 1rem auto; /* center */
}

#header button {
  margin: 0.2rem;
}

#player {
  display: block;
  /* centered with https://stackoverflow.com/a/2006008 */
  margin-left: -5rem; /* negative half of width */
  width: 10em;
  left: 50vw;
  /* sticky at top */
  position: fixed;
  top: 0;
  /* hidden if no qari is selected */
  transition: opacity 0.5s ease-in-out;
  opacity: 0;
  visibility: hidden;
  z-index: 30;  /* higher than the help toggle label */
}

/* help */

.help-part {
    margin-bottom: 0.4rem;
}

details, details * {
  margin: 0;
  margin-bottom: 0.5rem;
}

/* to apply margin only when open */
details > :last-child  { margin-bottom: 0.8rem; }

.details-content {
    background-color: var(--details-bg);
    box-shadow: 0 0 0.2em 0 var(--details-shadow);
    width: calc(var(--all-width) - 10%);  /* minus 2 times side padding */
    margin-right: -0.1em;  /* half blur radius */
    padding-top:    0.4rem;
    padding-bottom: 0.2rem;
    padding-left:  5%;
    padding-right: 5%;
}

b {
  display: block;
  color: black;
  margin: 0.8rem 0 0.2rem 0;
}

a { color: blue; }
a:visited { color: purple; }
a:hover { text-shadow: 1pt 1pt 2pt lightblue; }
a:active { color: red; text-shadow: 1pt 1pt 2pt lightblue; }

.tab { display: none; }  /* hide the checkbox */
.tab ~ label { user-select: none; }  /* it's easy to select it while clicking */

#help { display: flex; flex-direction: column-reverse; }

#help {
  margin: 0;
  box-sizing: border-box;
  width: var(--all-width);
}

#optiontoggle         + label:before { content: "أظهر" }
#optiontoggle:checked + label:before { content: "أخفِ"  }

#helpcontent ul {
    text-align: right;
}

.tab + label {
  font-weight: normal; /* bold */
  --label-gap: 0.5rem;
  --small-width: 1rem;
  --padding: 10px;
  --height: 1.3rem;
  --big-width: calc(var(--all-width) - 4*var(--padding) - var(--label-gap) - var(--small-width));  /* 2 paddings for each button */
  line-height: 1.2;
  padding: var(--padding);
  height: var(--height);
  background: var(--tab);
  color: var(--tab-txt);
  box-shadow: 1px 3px 4px rgba(0, 0, 0, 0.3);
  border-radius: 0 0 1rem 1rem;
  z-index: 20;
  position: relative;
}
#dark:checked ~ #body .tab + label {
  box-shadow: 1px 3px 4px rgba(255, 255, 255, 0.3);
}

#optiontoggle + label {
  width: var(--big-width);
}

#helptoggle + label {
  width: var(--small-width);
  right: calc(var(--big-width) + var(--label-gap) + 2*var(--padding));
  top: calc(-1*var(--height) - 2*var(--padding));
  margin-bottom: calc(-1*var(--height) - 1*var(--padding)); /* remove the space created by removing it; subtracted one padding not two to make room below */
}

.contentcontainer {
  width: calc(var(--all-width) - 0.2rem);  /* minus 2 times side padding */
  padding: 0.1rem;
  padding-bottom: 1rem;
  background: rgb(var(--content-rgb));
  box-shadow: 1px 3px 4px rgba(0, 0, 0, 0.3);
  margin: 0;
  margin-top: -1.1rem;
  z-index: 5;
}

#help summary {
  padding-left: 1rem;
  padding-right: 1rem;
}

#helptoggle:not(checked) ~ #helpcontent {
  overflow: hidden;
  max-height: 0;
  transition: max-height 1s cubic-bezier(0, 1.0, 0, 1.0),
              visibility 1s step-end;
  visibility: hidden;
}
#helptoggle:checked ~ #helpcontent {
  max-height: 32766px;
  transition: max-height 3s ease-in,
              visibility 3s step-start;
  visibility: visible;
}

#optiontoggle:not(checked) ~ #options {
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.55s ease-out,
              visibility 0.55s step-end;
  visibility: hidden;
}
#optiontoggle:checked ~ #options {
  max-height: 21rem;
  transition: max-height 0.5s linear,
              visibility 0.5s step-start;
  visibility: visible;
}

.tab + label:hover,
.tab + label:focus {
  background: var(--tab-active);
  color: var(--tab-active-txt);
}

kbd {
  font-family: serif;
  direction: ltr;
  font-size: 0.7rem;
  /* based on https://meta.superuser.com/q/4788 */
  background-color: #e7e7e7;
  border: 1px solid #888;
  border-radius: 0.5em;
  box-shadow: 0 1px 0 rgba(0,0,0,0.2),
              0 0 0 2px #fff inset;
  color: #000;
  display: inline-block;
  margin: 0 0.1em;
  padding: 0.1em 0.6em;
  text-shadow: 0 1px 0 #fff;
}

.roman { font-size: 80%; }
.roman, .roman * {
  font-family: serif;
  direction: ltr;
}

summary { outline: none; } /* hide bounding box when click */

/* https://stackoverflow.com/a/38215801 */
details[open] > .details-content {
  animation: fade-in .5s ease-in-out;
}
@keyframes fade-in {
  0%    { opacity: 0; }
  100%  { opacity: 1; }
}

#zzback { display: block; margin: auto; margin-top: 0.5em; }

#end_of_header {
  margin: 0;
  margin-top: 0.2em
}

</style>
</head>
<body>
<input type="checkbox" id="dark" hidden disabled>
<!-- this checkbox is tied to darkmode_input by js; it's used to avoid FOUC on reload. -->
<!-- https://alexandersandberg.com/theme-switcher/ -->
<div id="body"> <!-- encompasses the content and bg -->
<div id="all">  <!-- encompasses the content only -->

<section id="help">

<input type="checkbox" id="helptoggle" class="tab" onchange="help_toggled()">
<label for="helptoggle">؟</label>
<input type="checkbox" id="optiontoggle" class="tab" onchange="option_toggled()">
<label for="optiontoggle">&nbsp;الخيارات</label>

<div id="options" class="contentcontainer">

  <div id="darkmode_option" class="option optionally-inline">
    <label for="darkmode_input">الوضع الليلي؟&ensp;</label><input id="darkmode_input" type="checkbox" onchange="chstyle()">
  </div>
  <div id="teacher_option" class="option optionally-inline">
    <label for="teacher_input">معلم؟ (التلاوة الصوتية قبل الآية)&ensp;</label><input id="teacher_input" type="checkbox" onchange="">
  </div>

  <!-- from: http://www.everyayah.com/data/recitations.js -->
  <div class="option">
    <label for="qaris">تلاوة بصوت:&ensp;</label><select id="qaris" oninput="audio.update_qari(this.value)">
      <option value="" selected>بغير تلاوة صوتية</option>
    <option value="warsh/warsh_ibrahim_aldosary_128kbps">إبراهيم الدوسري (ورش) (جودة فائقة)</option>
    <option value="Abu_Bakr_Ash-Shaatree_64kbps">أبو بكر الشاطري (جودة عالية)</option>
    <option value="Abu_Bakr_Ash-Shaatree_128kbps">أبو بكر الشاطري (جودة فائقة)</option>
    <option value="Ahmed_ibn_Ali_al-Ajamy_64kbps_QuranExplorer.Com">أحمد بن علي العجمي (جودة عالية) [موقع QuranExplorer.Com]</option>
    <option value="ahmed_ibn_ali_al_ajamy_128kbps">أحمد بن علي العجمي (جودة فائقة)</option>
    <option value="Ahmed_ibn_Ali_al-Ajamy_128kbps_ketaballah.net">أحمد بن علي العجمي (جودة فائقة) [موقع ketaballah.net]</option>
    <option value="Ahmed_Neana_128kbps">أحمد نعينع (جودة فائقة)</option>
    <option value="Hudhaify_32kbps">الحذيفي (جودة متوسطة)</option>
    <option value="Hudhaify_64kbps">الحذيفي (جودة عالية)</option>
    <option value="Hudhaify_128kbps">الحذيفي (جودة فائقة)</option>
    <option value="Husary_64kbps">الحصري (جودة عالية)</option>
    <option value="Husary_Mujawwad_64kbps">الحصري (مجود) (جودة عالية)</option>
    <option value="Husary_128kbps">الحصري (جودة فائقة)</option>
    <option value="Husary_128kbps_Mujawwad">الحصري (مجود) (جودة فائقة)</option>
    <option value="Husary_Muallim_128kbps">الحصري (معلم) (جودة فائقة)</option>
    <option value="Menshawi_16kbps">المنشاوي (جودة منخفضة)</option>
    <option value="Menshawi_32kbps">المنشاوي (جودة متوسطة)</option>
    <option value="Minshawy_Mujawwad_64kbps">المنشاوي (مجود) (جودة عالية)</option>
    <option value="Minshawy_Mujawwad_192kbps">المنشاوي (مجود) (جودة فائقة)</option>
    <option value="Minshawy_Murattal_128kbps">المنشاوي (مرتل) (جودة فائقة)</option>
    <option value="Khaalid_Abdullaah_al-Qahtaanee_192kbps">خالد القحطاني (جودة فائقة)</option>
    <option value="khalefa_al_tunaiji_64kbps">خليفة الطنيجي (جودة عالية)</option>
    <option value="Ghamadi_40kbps">سعد الغامدي (جودة متوسطة عالية)</option>
    <option value="Saood_ash-Shuraym_64kbps">سعود الشريم (جودة عالية)</option>
    <option value="Saood_ash-Shuraym_128kbps">سعود الشريم (جودة فائقة)</option>
    <option value="Abdul_Basit_Murattal_64kbps">عبد الباسط عبد الصمد (مرتل) (جودة عالية)</option>
    <option value="AbdulSamad_64kbps_QuranExplorer.Com">عبد الباسط عبد الصمد (جودة عالية) [موقع QuranExplorer.Com]</option>
    <option value="Abdul_Basit_Mujawwad_128kbps">عبد الباسط عبد الصمد (مجود) (جودة فائقة)</option>
    <option value="Abdul_Basit_Murattal_192kbps">عبد الباسط عبد الصمد (مرتل) (جودة فائقة)</option>
    <option value="warsh/warsh_Abdul_Basit_128kbps">عبد الباسط عبد الصمد (ورش) (جودة فائقة)</option>
    <option value="Abdurrahmaan_As-Sudais_64kbps">عبد الرحمن السديس (جودة عالية)</option>
    <option value="Abdurrahmaan_As-Sudais_192kbps">عبد الرحمن السديس (جودة فائقة)</option>
    <option value="Abdullah_Basfar_32kbps">عبد الله بصفر (جودة متوسطة)</option>
    <option value="Abdullah_Basfar_64kbps">عبد الله بصفر (جودة عالية)</option>
    <option value="Abdullah_Basfar_192kbps">عبد الله بصفر (جودة فائقة)</option>
    <option value="Abdullah_Matroud_128kbps">عبد الله مطرود (جودة فائقة)</option>
    <option value="Maher_AlMuaiqly_64kbps">ماهر المعيقلي (جودة عالية)</option>
    <option value="MaherAlMuaiqly128kbps">ماهر المعيقلي (جودة فائقة)</option>
    <option value="Mohammad_al_Tablaway_64kbps">محمد الطبلاوي (جودة عالية)</option>
    <option value="Mohammad_al_Tablaway_128kbps">محمد الطبلاوي (جودة فائقة)</option>
    <option value="Muhammad_Jibreel_64kbps">محمد جبريل (جودة عالية)</option>
    <option value="Muhammad_Jibreel_128kbps">محمد جبريل (جودة فائقة)</option>
    <option value="mahmoud_ali_al_banna_32kbps">محمود علي البنا (جودة متوسطة)</option>
    <option value="Alafasy_64kbps">مشاري العفاسي (جودة عالية)</option>
    <option value="Alafasy_128kbps">مشاري العفاسي (جودة فائقة)</option>
    <option value="Mustafa_Ismail_48kbps">مصطفى إسماعيل (جودة متوسطة عالية)</option>
    <option value="Yasser_Ad-Dussary_128kbps">ياسر الدوسري (جودة فائقة)</option>
    <option value="Yaser_Salamah_128kbps">ياسر سلامة (جودة فائقة)</option>
    <option value="warsh/warsh_yassin_al_jazaery_64kbps">ياسين الجزائري (ورش) (جودة عالية)</option>

    </select>
    <input type="hidden" id="qariurl" value="">
  </div>

  <hr id="guide">

  <div id="quizmode_option" class="option">
    <label for="quizmode">وضع التسميع:&ensp;</label><select id="quizmode" onchange="chquizmode()">
      <option value="uthm" selected>عثماني (بلا كتابة) &mdash; تغييره يتطلب إعادة التسميع</option>
      <option value="imla">إملائي (كتابة) &mdash; تغييره يتطلب إعادة التسميع</option>
    </select>
  </div>

  <div class="mode_options" id="uthm_options">
    <span id="uthm_options_title" class="mode_options_title">خيارات وضع التسميع العثماني (بدون كتابة):</span>

    <div class="option">
      <label for="mvbtns_input">موضع أزار التسميع:&ensp;</label><select id="mvbtns_input" onchange="chstyle()">
        <option value="bottom" selected>أسفل</option>
        <option value="right">يمين</option>
        <option value="left">يسار</option>
      </select>
    </div>

    <div class="option">
      <label for="textclr_input">تلوين النص:&ensp;</label><select id="textclr_input" onchange="chstyle()">
        <option value="taj" selected>تبعا لقواعد التجويد</option>
        <option value="bas">تلوين أجزاء الرسم</option>
        <option value="no">بغير أي تلوين</option>
      </select>
    </div>

    <div class="option">
      <label for="ayatnum_input">تلوين أرقام الآيات؟&ensp;</label><input id="ayatnum_input" type="checkbox" checked onchange="chstyle()">
    </div>

  </div>

  <div class="mode_options" id="imla_options" style="display:none">
    <span id="imla_options_title" class="mode_options_title">خيارات وضع التسميع الإملائي (كتابة):</span>

    <div class="option">
      <label for="feedbackrate">مراجعة الأخطاء كل:&ensp;</label><select id="feedbackrate" onchange="chfeedbackrate()">
        <option value="" selected>حرف</option>
        <option value="word">كلمة</option>
      </select>
    </div>

  </div>

</div>

<dl class="contentcontainer" id="helpcontent">

<br>
<h2 class="help-part">أسئلة عامة</h2>
<details><summary>ما هذا؟</summary><div class="details-content">
<p>هذا تطبيق يساعدك على اختبار حفظك من&nbsp;القرآن الكريم.</p>
</div></details>
<details><summary>أليست المراجعة مع شيخ مُجيد أفضل؟</summary><div class="details-content">
<p>بالتأكيد؛ ما هذا التطبيق إلا وسيلةً مساعدة. ولن يفيد من&nbsp;لا&nbsp;يستطيع التلاوة الصحيحة من&nbsp;المصحف بالتجويد. ولن يُصحح لك أخطاء التجويد إن لم تكن تعلم معنى العلامات المستخدمة في المصحف.</p>
<p>فالهدف من&nbsp;هذا التطبيق ليس استبدال المعلم، بل أن يكون مكمّلا ومساعدا لك، فلا معنى للحفظ من&nbsp;غير تصحيح التلاوة، وهذا لا&nbsp;يساعدك فيه إلا <strong>إنسان</strong> مُجيد.</p>
<p>انظر أيضا النقطة «يجب التلاوة على شيخ مُجيد، وعدم الاعتماد على الرسم الإملائي» بالأسفل.</p>
</div></details>
<details><summary>هل سيساعدني هذا التطبيق على الحفظ؟</summary><div class="details-content">
<p>لا. هذا ليس إلا وسيلة لاختبار حفظك ومعرفة نقاط ضعفك ومن ثَم مساعدتك على تثبيت حفظك. لكنه ليس للتحفيظ؛ عليك أن تحفظ مع شيخ مُجيد أولا ليضبط لك النطق، وبعد أن تحفظ، تستطيع أن تراجع هنا.</p>
<p>ولكن يمكنك استخدامه عبر مشروعنا الآخر «<a href="../zz" target="_blank">ذِكر الذِكر</a>»، فهو «نظام <a href="https://ar.wikipedia.org/wiki/تكرار_متباعد" target="_blank">تكرار متباعد</a>» ليساعدك في تثبيت حفظك للقرآن الكريم. و«ذِكر الذِكر» يستخدم هذا التطبيق لاختبار حفظك، لكنه يسهّل عليك تقسيم الحفظ واختيار ما تحتاج مراجعته.</p>
</div></details>
<details><summary>أليست الكتابة أفضل؟</summary><div class="details-content">
<p>نعم، الكتابة يدويا على لوح بالرسم العثماني هي من&nbsp;أفضل الطرق على الإطلاق لتثبيت حفظ القرآن الكريم. وهي الطريقة المتبعة في الكثير من&nbsp;الدول الإسلامية خصوصا في أفريقيا.</p>
<p>ولكن الكتابة بالرسم العثماني على الحاسوب ليست يسيرة. وإذا أردنا أن نقارب، فنكتب بالرسم الإملائي الحديث ومن غير تشكيل، فسنجد أنها تصير بطيئة ومتعبة عند الاقتراب من&nbsp;نهاية حزب واحد (تختلف من&nbsp;شخص لآخر).</p>
<p>ولكن إذا أردت تجربتها، فيمكنك اختيار الوضع الـ«إملائي» من&nbsp;أمام «وضع التسميع» في شاشة «الخيارات» ثم&nbsp;بدء التسميع (أو&nbsp;اضغط «إعادة» إن كنت قد بدأت التسميع بالفعل).</p>
<p>شخصيا أنصح بالطريقتين معا؛ فإظهار الكلمات بالرسم العثماني يُماثل القراءة من&nbsp;المصحف ويسهل عليك مراجعة حركات الحروف (بالتجويد) كما أنه سريع نسبيا مما يتيح مراجعة كمّ أكبر في وقت أقل، والكتابة تجبرك على التلاوة بتمهّل وإدخال كل كلمة حرفا حرفا ومعرفة مواضع الفواصل بين الكلمات والآيات.</p>
</div></details>
<details><summary>كيف أستخدمه؟</summary><div class="details-content">
<p>اختر سورةً تود تسميعها من&nbsp;الخانة التي أمام «من&nbsp;السورة»، ثم&nbsp;اضغط زر «ابدأ»، سيظهر شريط أزرار. كل ضغطة على الزر الكبير <span style="white-space:nowrap">(<kbd>&#x276e;</kbd>)</span> ستُظهر كلمة.</p>
<p>انظر أيضا النقطة «يمكنك الانتقال إلى&nbsp;الأمام وإلى الخلف، بالكلمة وبالآية وبالعبارة» بالأسفل.<br>
وإذا كنت تستخدم الوضع الإملائي (الكتابي)، فانظر النقطة «كيف أستخدم التسميع الكتابي (الوضع الإملائي)؟» بالأسفل.</p>
<p>اتلُ الجزء الذي حددته، وبعد تلاوة كل كلمة، اضغط على الزر حتى تُظهرها. فإذا كانت صحيحة (بتشكيلها)، تابع تلاوتك، وإلا فسجّل هذا الموضع في كراسة مثلا، وأعد تلاوتك من&nbsp;بداية الآية أو&nbsp;من&nbsp;الآية السابقة، حتى تصل إلى&nbsp;الكلمة التالية، ثم&nbsp;اضغط لإظهارها. واستمر هكذا حتى تنتهي. ثم&nbsp;راجع المواضع التي أخطأت فيها.</p>
<p>ويمكنك استخدامه عبر مشروعنا الآخر «<a href="../zz" target="_blank">ذِكر الذِكر</a>»، فهو «نظام <a href="https://ar.wikipedia.org/wiki/تكرار_متباعد" target="_blank">تكرار متباعد</a>» ليساعدك في تثبيت حفظك للقرآن الكريم. و«ذِكر الذِكر» يستخدم هذا التطبيق لاختبار حفظك، لكنه يسهّل عليك تقسيم الحفظ واختيار ما تحتاج مراجعته.</p>
</div></details>
<details><summary>لماذا توجد خانتين لإدخال السورة المرادة؟</summary><div class="details-content">
<p>لأن هذا التطبيق يتيح لك مراجعة أي عدد من&nbsp;الآيات المتتالية في المصحف، بغض النظر عن سورها. فتستطيع مثلا مراجعة الجزء الثالث، والذي يبدأ في سورة البقرة وينتهي في منتصف سورة آل&nbsp;عمران. كذلك تستطيع مراجعة حزب معين، أو&nbsp;ربع، أو&nbsp;حتى صفحة واحدة، أو&nbsp;صفحتين متقابلتين، أو&nbsp;عشر سور متتالية. كل ما عليك هو تحديد آية البداية وسورتها، وآية النهاية وسورتها.</p>
</div></details>
<details><summary>كيف يمكنني الاستماع إلى&nbsp;التلاوة الصوتية للآيات؟</summary><div class="details-content">
<p>اضغط على «أظهر الخيارات» ثم&nbsp;اختر القارئ الذي تحب الاستماع إليه من&nbsp;الخانة التي أمام «تلاوة بصوت». وعندئذ، بمجرد إظهار الكلمة الأخيرة من&nbsp;كل آية (أو&nbsp;ضغط <kbd>Enter</kbd> في نهايتها في الوضع الإملائي)، سيتلو القارئ هذه الآية.</p>
<p>انظر أيضا سؤال «ما هو الوضع المعلم؟» التالي.</p>
<p>جزى الله خيرا القائمين على مشروع
<span dir="ltr" class="roman"><a href="http://www.versebyversequran.com/" target="_blank">Verse By Verse MP3 Quran</a></span>
لتوفيرهم التلاوات الصوتية لنا ولبرنامج <a href="https://quran.ksu.edu.sa/" target="_blank">آيات</a>.</p>
</div></details>
<details><summary>ما هو الوضع المعلم؟</summary><div class="details-content">
<p>قبل تفعيل الوضع المعلم، فإن عند اختيارك لتلاوة صوتية، ستسمع كل آية بعد تسميعها. أما الوضع المعلم فسيجعل التلاوة الصوتية للآية <strong>قبل</strong> تسميعها.</p>
</div></details>
<details><summary>كيف أستخدم التسميع الكتابي (الوضع الإملائي)؟</summary><div class="details-content">
<p>بمجرد اختياره من&nbsp;شاشة «الخيارات» من&nbsp;أمام «وضع التسميع» ثم&nbsp;بدء التسميع (أو&nbsp;إعادته إن كنت قد بدأت التسميع على الوضع العثماني)، فستجد أن خانة الكتابة محددة آليا حتى تبدأ الكتابة فيها مباشرة.</p>
<p>لاحظ أن:</p>
<ul>
<li><p>الآية الأولى من&nbsp;جميع السور مسبوقة بالبسملة على سطر وحدها (باستثناء سورة التوبة، فهي لا&nbsp;تبدأ بالبسملة مطلقا، وكذلك الفاتحة لأن آيتها الأولى <strong>هي</strong> البسملة).</p></li>
<li><p>كل آية على سطر وحدها، أي تنتهي بضغطة على زر <kbd>Enter</kbd>، حتى الآية الأخيرة تنتهي بضغطة على زر <kbd>Enter</kbd>.</p></li>
<li><p>بين كل كلمة في الآية مسافة واحدة فقط. ولا مسافة قبل الكلمة الأولى من&nbsp;الآية ولا بعد الكلمة الأخيرة منها.</p></li>
<li><p>بمجرد انتهاء الآية (بضغط زر <kbd>Enter</kbd>)، يُضاف رقم الآية آليا، وإذا كنت قد اخترت قارئا من&nbsp;شاشة «الخيارات» فسيتلوها كذلك.</p></li>
<li><p>عند الخطأ في أي حرف، يتغير لون خانة الكتابة إلى&nbsp;الأحمر.</p></li>
<li><p>يمكن جعل مراجعة الأخطاء تتم بعد كل كلمة وليس كل حرف، من&nbsp;شاشة «الخيارات».</p></li>
<li><p>الألف المقصورة والياء حرفان مختلفان. الألف المقصورة هي ألف في آخر الكلمة وتُرسم ياءً بغير نقطتين، وتوجد في الصف الأسفل من&nbsp;لوحة المفاتيح، تحت زر الألف غالبا. أما الياء فتحتها نقطتين <strong>دائما</strong>، حتى في آخر الكلمة. وتوجد غالبا على الزر الثالث من&nbsp;اليسار في الصف الأوسط، بين الباء والسين.</p></li>
<li><p>الهمزات صعبة. أعرف هذا. <span dir="ltr" class="roman">¯\_(ツ)_/¯</span></p></li>
</ul>
</div></details>
<details><summary>لدي مشكلة أو&nbsp;اقتراح، كيف أتواصل معك؟</summary><div class="details-content">
<p>عبر <a href="https://github.com/noureddin/recite/issues" target="_blank">مسائل <span dir="ltr" class="roman">GitHub</span></a>،
أو&nbsp;البريد الإلكتروني:
<a id="xyz" class="roman" href="#" target="_blank">[hidden]</a>،
على أن توضّح في الحالتين في العنوان أنك تقصد «رسايت ويب» (اسم هذا التطبيق).</p>
</div></details>
<h2 class="help-part">ملاحظات متفرقة</h2>
<details><summary>النص في هذا التطبيق برواية حفص عن عاصم.</summary><div class="details-content">
</b><p>
<p>حتى عند اختيار تلاوة صوتية براوية ورش عن نافع، يظل النص القرآني برواية حفص عن عاصم.</p>
</div></details>
<details><summary>النص العثماني للقرآن ملون تبعا لقواعد التجويد، ويمكن تغيير ذلك.</summary><div class="details-content">
<p>يمكن تغيير ذلك من&nbsp;خانة «تلوين النص» في شاشة «الخيارات»، والتي تتيح لنا ثلاث قيم:</p>
<ul>
<li><p><strong>تبعا لقواعد التجويد:</strong> مثل مصحف التجويد الملون من&nbsp;<a href="http://easyquran.com" target="_blank">دار المعرفة</a>؛ تدرجات الأحمر للمدود، والأخضر للإخفاء والغنة، وأزرقان أحدهما للقلقلة والآخر لتفخيم الراء، بينما الرمادي لا&nbsp;يلفظ.</p></li>
<li><p><strong>تلوين أجزاء الرسم:</strong> النص العثماني الأساسي بالأسود، والنقاط والتشكيل والحروف المزيدة بالأحمر، والهمزات بالأصفر البرتقالي، وعلامات الوقف بالأزرق.</p></li>
<li><p><strong>بغير تلوين:</strong> الخط كله باللون الأسود، من&nbsp;غير أي تلوين.</p></li>
</ul>
<p>رجاءً لاحظ أن تلوين النص تبعا لقواعد التجويد لا&nbsp;يزال في مراحله الأولى، وهو ليس منسوخا مباشرة من&nbsp;مصحف دار المعرفة، بل هو اجتهاد شخصي مني حاولت فيه مقاربة مصحف دار المعرفة قدر الإمكان؛ فأي خطأ تجده في الألوان أرجو أن تراسلني به حتى أصلحه.</p>
</div></details>
<details><summary>تستطيع استخدام لوحة المفاتيح وحدها، من&nbsp;غير المؤشر (الفأرة أو&nbsp;لوحة اللمس).</summary><div class="details-content">
<p>استخدم زر <kbd>Tab</kbd> للوصول إلى&nbsp;قائمة «من&nbsp;سورة». عندئذ زرّي <kbd>↑</kbd> («سهم لأعلى») و&nbsp;<kbd>↓</kbd> («سهم لأسفل») ينقلانك بين السور بالترتيب،
وتستطيع أيضا كتابة جزء من&nbsp;بداية اسم السورة للوصول إليها سريعا،
وزرّ المسافة يظهر لك القائمة. وبعد تحديد السورة، زر <kbd>Enter</kbd> ينقلك للخانة التالية، خانة اختيار آية البداية.
عندئذ تستطيع كتابة رقم الآية مباشرةً أو&nbsp;استخدام زرّي <kbd>↑</kbd> («سهم لأعلى») و<kbd>↓</kbd> («سهم لأسفل»).
زر <kbd>Enter</kbd> ينقلك للخانة التالية، ثم&nbsp;للخانة للأخيرة، ثم&nbsp;إلى&nbsp;زر «ابدأ»، والذي عنده زر <kbd>Enter</kbd> أو&nbsp;المسافة يظهر الكلمة التالية.</p>
</div></details>
<details><summary>يمكنك الانتقال إلى&nbsp;الأمام وإلى الخلف، بالكلمة وبالآية وبالعبارة.</summary><div class="details-content">
<ul>
<li><p>زر المسافة أو&nbsp;<kbd>Enter</kbd> أو&nbsp;سهم يسار: إظهار الكلمة التالية (مثل زر <kbd>&#x276e;</kbd> بأسفل الشاشة).</p></li>
<li><p>زر إظهار الكلمة التالية + <kbd>Shift</kbd> أو&nbsp;<kbd>Ctrl</kbd> أو&nbsp;<kbd>Alt</kbd>: إظهار الآية الحالية بالكامل (مثل زر <kbd>&#x276e;&#x276e;&#x276e;</kbd> بأسفل الشاشة).</p></li>
<li><p>زر <kbd>Backspace</kbd> أو&nbsp;سهم يمين: إخفاء الكلمة الحالية (مثل زر <kbd>&#x276f;</kbd> بأسفل الشاشة).</p></li>
<li><p>زر إخفاء الكلمة الحالية + <kbd>Shift</kbd> أو&nbsp;<kbd>Ctrl</kbd> أو&nbsp;<kbd>Alt</kbd>: إخفاء الآية الحالية بالكامل (مثل زر <kbd>&#x276f;&#x276f;&#x276f;</kbd> بأسفل الشاشة).</p></li>
</ul>
<hr>
<p>«العبارة» المقصود بها تقسيم الآية بعلامات الوقف:</p>
<ul>
<li><p>فمن بداية الآية حتى علامة الوقف الأولى هو عبارة،</p></li>
<li><p>ومن علامة الوقف الأخيرة في الآية حتى نهاية الآية هو عبارة،</p></li>
<li><p>وما بين علامتي وقف هو عبارة.</p></li>
</ul>
<p>وتستخدم:</p>
<ul>
<li><p>زر الصفر للانتقال عبارة واحدة إلى&nbsp;الأمام (مثل زر <kbd>&#x276e;&#x276e;</kbd> بأسفل الشاشة).</p></li>
<li><p>زر الواحد للانتقال عبارة واحدة إلى&nbsp;الخلف (مثل زر <kbd>&#x276f;&#x276f;</kbd> بأسفل الشاشة).</p></li>
</ul>
</div></details>
<details><summary>يجب التلاوة على شيخ مُجيد، وعدم الاعتماد على الرسم الإملائي.</summary><div class="details-content">
<p>القرآن لا&nbsp;يُعلَّم إلا بالمشافهة، أي أن تسمع القرآن من&nbsp;شيخ مُجيد وتتلو عليه ليصحح لك نطقك.</p>
<p>الكتابة أمرٌ ثانوي عند حفظ القرآن.</p>
<p>القراءة من&nbsp;المصحف ووضع التسميع العثماني لن يساعداك إذا لم تسمع التلاوة الصحيحة، وتتلوها على شيخ مُجيد ليصحح لك النطق.</p>
<p>وأيضا وضع التسميع الإملائي (الكتابي) لا&nbsp;يختبر التشكيل، مما قد يسبب أخطاءً مهولة، مثل إبدال المتكلم والمخاطب مثل «أنعمتَ» في&nbsp;الآية&nbsp;الأخيرة من&nbsp;سورة&nbsp;الفاتحة، أو&nbsp;إبدال الفاعل والمفعول&nbsp;به مثل «وإذ ابتلى إبراهيمَ ربُّه» في&nbsp;الآية&nbsp;١٢٤ من&nbsp;سورة&nbsp;البقرة أو&nbsp;«إنما يخشى اللهَ من&nbsp;عباده العلماءُ» في&nbsp;الآية&nbsp;٢٨ من&nbsp;سورة&nbsp;فاطر.</p>
<p>ما هذا التطبيق إلا وسيلة مساعدة لاختبار الحفظ لتثبيته. ولكنه ليس بديلا عن معلم إنسان.</p>
</div></details>
<details><summary>يمكن برمجة هذا التطبيق أو&nbsp;تضمينه في برامج ويب أخرى.</summary><div class="details-content">
<p>باستخدام مُعامِلات الرابط، يمكن تحديد القيم المبدئية لجميع الخيارات، بل وتحديد الآيات المراد تسميعها، حتى بتقسيمات غير متاحة في واجهة الويب، مثل «تسميع الصفحة العاشرة وخمس آيات بعدها» أو&nbsp;«الجزأين الثالث والرابع وآية قبلهما وآيتين بعدهما»، وغير ذلك.</p>
<p>انظر صفحة اقرأني <a href="https://github.com/noureddin/recite/blob/gh-pages/اقرأني.md" target="_blank">بالعربية</a> أو&nbsp;<a href="https://github.com/noureddin/recite/blob/gh-pages/README.md" target="_blank">بالإنجليزية</a> في مستودع المشروع.</p>
</div></details>
<details><summary>لم يُدقق هذا النص رسميًا بعد.</summary><div class="details-content">
<p>إذا وجدت فيه أي خطأ، رجاءً أبلغني في أسرع وقت! هذا النص يستخدم النسخة الأخيرة (المؤرخة ١٩&nbsp;/&nbsp;٠٥&nbsp;/&nbsp;٢٠٢٠) من&nbsp;مشروع
<span dir="ltr" class="roman"><a href="https://github.com/khaledhosny/quran-data" target="_blank">Quran&nbsp;Data</a></span>.</p>
<p>أما النص الإملائي فهو من&nbsp;<a href="https://ar.wikisource.org/wiki/القرآن_الكريم/النص_المجرد" target="_blank">ويكي&zwnj;مصدر</a>.</p>
</div></details>


</dl>
</section>

<audio id="player" controls preload></audio>

<!-- I used to use sura_start, sura_end, aya_start, and aya_end, but changed -->
<!--  them to sura_bgn, sura_end, aaya_bgn, and aaya_end to make them equal in -->
<!--  length and show their parallelism, thus making the code a little easier. -->
<!-- Also note that aaya is a more accurate transliteration than aya and ayah, -->
<!--  and rhymes with sura, both have a stressed, long vowel in the first -->
<!--  syllable, and a short unstressed vowel in the second syllable. -->

<p id="title"></p>

<div id="selectors">

  <div>
    <label for="sura_bgn">من سورة:</label>
    <select id="sura_bgn">
      <option value="" selected>السورة</option>
      <option value="0">الفاتحة</option><option value="1">البقرة</option><option value="2">آل عمران</option><option value="3">النساء</option><option value="4">المائدة</option><option value="5">الأنعام</option><option value="6">الأعراف</option><option value="7">الأنفال</option><option value="8">التوبة</option><option value="9">يونس</option><option value="10">هود</option><option value="11">يوسف</option><option value="12">الرعد</option><option value="13">إبراهيم</option><option value="14">الحجر</option><option value="15">النحل</option><option value="16">الإسراء</option><option value="17">الكهف</option><option value="18">مريم</option><option value="19">طه</option><option value="20">الأنبياء</option><option value="21">الحج</option><option value="22">المؤمنون</option><option value="23">النور</option><option value="24">الفرقان</option><option value="25">الشعراء</option><option value="26">النمل</option><option value="27">القصص</option><option value="28">العنكبوت</option><option value="29">الروم</option><option value="30">لقمان</option><option value="31">السجدة</option><option value="32">الأحزاب</option><option value="33">سبأ</option><option value="34">فاطر</option><option value="35">يس</option><option value="36">الصافات</option><option value="37">ص</option><option value="38">الزمر</option><option value="39">غافر</option><option value="40">فصلت</option><option value="41">الشورى</option><option value="42">الزخرف</option><option value="43">الدخان</option><option value="44">الجاثية</option><option value="45">الأحقاف</option><option value="46">محمد</option><option value="47">الفتح</option><option value="48">الحجرات</option><option value="49">ق</option><option value="50">الذاريات</option><option value="51">الطور</option><option value="52">النجم</option><option value="53">القمر</option><option value="54">الرحمن</option><option value="55">الواقعة</option><option value="56">الحديد</option><option value="57">المجادلة</option><option value="58">الحشر</option><option value="59">الممتحنة</option><option value="60">الصف</option><option value="61">الجمعة</option><option value="62">المنافقون</option><option value="63">التغابن</option><option value="64">الطلاق</option><option value="65">التحريم</option><option value="66">الملك</option><option value="67">القلم</option><option value="68">الحاقة</option><option value="69">المعارج</option><option value="70">نوح</option><option value="71">الجن</option><option value="72">المزمل</option><option value="73">المدثر</option><option value="74">القيامة</option><option value="75">الإنسان</option><option value="76">المرسلات</option><option value="77">النبأ</option><option value="78">النازعات</option><option value="79">عبس</option><option value="80">التكوير</option><option value="81">الانفطار</option><option value="82">المطففين</option><option value="83">الانشقاق</option><option value="84">البروج</option><option value="85">الطارق</option><option value="86">الأعلى</option><option value="87">الغاشية</option><option value="88">الفجر</option><option value="89">البلد</option><option value="90">الشمس</option><option value="91">الليل</option><option value="92">الضحى</option><option value="93">الشرح</option><option value="94">التين</option><option value="95">العلق</option><option value="96">القدر</option><option value="97">البينة</option><option value="98">الزلزلة</option><option value="99">العاديات</option><option value="100">القارعة</option><option value="101">التكاثر</option><option value="102">العصر</option><option value="103">الهمزة</option><option value="104">الفيل</option><option value="105">قريش</option><option value="106">الماعون</option><option value="107">الكوثر</option><option value="108">الكافرون</option><option value="109">النصر</option><option value="110">المسد</option><option value="111">الإخلاص</option><option value="112">الفلق</option><option value="113">الناس</option>
    </select>
    <label for="aaya_bgn">الآية:</label>
    <input id="aaya_bgn">
  </div>

  <div>
    <label for="sura_end">إلى سورة:</label>
    <select id="sura_end">
      <option value="" selected>السورة</option>
      <option value="0">الفاتحة</option><option value="1">البقرة</option><option value="2">آل عمران</option><option value="3">النساء</option><option value="4">المائدة</option><option value="5">الأنعام</option><option value="6">الأعراف</option><option value="7">الأنفال</option><option value="8">التوبة</option><option value="9">يونس</option><option value="10">هود</option><option value="11">يوسف</option><option value="12">الرعد</option><option value="13">إبراهيم</option><option value="14">الحجر</option><option value="15">النحل</option><option value="16">الإسراء</option><option value="17">الكهف</option><option value="18">مريم</option><option value="19">طه</option><option value="20">الأنبياء</option><option value="21">الحج</option><option value="22">المؤمنون</option><option value="23">النور</option><option value="24">الفرقان</option><option value="25">الشعراء</option><option value="26">النمل</option><option value="27">القصص</option><option value="28">العنكبوت</option><option value="29">الروم</option><option value="30">لقمان</option><option value="31">السجدة</option><option value="32">الأحزاب</option><option value="33">سبأ</option><option value="34">فاطر</option><option value="35">يس</option><option value="36">الصافات</option><option value="37">ص</option><option value="38">الزمر</option><option value="39">غافر</option><option value="40">فصلت</option><option value="41">الشورى</option><option value="42">الزخرف</option><option value="43">الدخان</option><option value="44">الجاثية</option><option value="45">الأحقاف</option><option value="46">محمد</option><option value="47">الفتح</option><option value="48">الحجرات</option><option value="49">ق</option><option value="50">الذاريات</option><option value="51">الطور</option><option value="52">النجم</option><option value="53">القمر</option><option value="54">الرحمن</option><option value="55">الواقعة</option><option value="56">الحديد</option><option value="57">المجادلة</option><option value="58">الحشر</option><option value="59">الممتحنة</option><option value="60">الصف</option><option value="61">الجمعة</option><option value="62">المنافقون</option><option value="63">التغابن</option><option value="64">الطلاق</option><option value="65">التحريم</option><option value="66">الملك</option><option value="67">القلم</option><option value="68">الحاقة</option><option value="69">المعارج</option><option value="70">نوح</option><option value="71">الجن</option><option value="72">المزمل</option><option value="73">المدثر</option><option value="74">القيامة</option><option value="75">الإنسان</option><option value="76">المرسلات</option><option value="77">النبأ</option><option value="78">النازعات</option><option value="79">عبس</option><option value="80">التكوير</option><option value="81">الانفطار</option><option value="82">المطففين</option><option value="83">الانشقاق</option><option value="84">البروج</option><option value="85">الطارق</option><option value="86">الأعلى</option><option value="87">الغاشية</option><option value="88">الفجر</option><option value="89">البلد</option><option value="90">الشمس</option><option value="91">الليل</option><option value="92">الضحى</option><option value="93">الشرح</option><option value="94">التين</option><option value="95">العلق</option><option value="96">القدر</option><option value="97">البينة</option><option value="98">الزلزلة</option><option value="99">العاديات</option><option value="100">القارعة</option><option value="101">التكاثر</option><option value="102">العصر</option><option value="103">الهمزة</option><option value="104">الفيل</option><option value="105">قريش</option><option value="106">الماعون</option><option value="107">الكوثر</option><option value="108">الكافرون</option><option value="109">النصر</option><option value="110">المسد</option><option value="111">الإخلاص</option><option value="112">الفلق</option><option value="113">الناس</option>
    </select>
    <label for="aaya_end">الآية:</label>
    <input id="aaya_end">
  </div>

<button disabled title="حدد ما تريد مراجعته أو تسميعه، ثم اضغط على هذا الزر." id="ok">ابدأ</button>
<hr>

</div>

<div hidden id="header">
<div>
<button id="zzignore" hidden>تجاهل</button>
<button title="اضغط لبدء مراجعة جديدة" id="new">جديد</button>
<button title="اضغط لإعادة هذا التسميع من البداية" id="repeat">إعادة</button>
</div>
<hr id="end_of_header">
</div>

<div id="uthm_txt"></div>

<textarea hidden id="imla_txt" placeholder="اكتب هنا">
</textarea>

<div hidden id="endmsg">
بارك الله فيك وفتح عليك!&nbsp;<svg style="height:1.5em; vertical-align:sub" enable-background="new 0 0 128 128" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="m27.98 54.66 46.39 46.39-63.31 22.68c-3.59 1.28-7.05-2.18-5.76-5.76l22.68-63.31z" fill="#FFC107"/><defs><path id="c" d="m27.98 54.66 46.39 46.39-63.31 22.68c-3.59 1.28-7.05-2.18-5.76-5.76l22.68-63.31z"/></defs><clipPath id="a"><use xlink:href="#c"/></clipPath><g clip-path="url(#a)"><path d="m39.4 123.94c-8.46-1.78-16.1-3.92-23.29-8.95-6.74-4.71-13.66-11.78-16.33-19.71-2.08-6.18-11.36-1.8-7.97 3.36 5.52 8.4 11.16 15.77 19.73 21.31 7.8 5.05 17.82 8.93 27.23 8.69 2.59-0.07 3.36-4.12 0.63-4.7z" fill="#FF8F00"/></g><g clip-path="url(#a)"><path d="m51.07 113.71c-8.46-1.78-16.1-3.92-23.29-8.95-6.74-4.71-13.66-11.78-16.33-19.71-2.08-6.18-11.36-1.8-7.97 3.36 5.52 8.4 11.16 15.77 19.73 21.31 7.8 5.05 17.82 8.93 27.23 8.69 2.6-0.07 3.36-4.13 0.63-4.7z" fill="#FF8F00"/></g><g clip-path="url(#a)"><path d="m76.71 106.66c-12.95-2.49-24.54-5.73-35.55-13.37-10.36-7.19-20.33-17.69-24.86-29.64-2.27-5.98-11.16-2.02-7.97 3.36 7.39 12.46 16.01 23.17 28.23 31.23 11.23 7.41 25.85 13.37 39.52 13.12 2.59-0.05 3.37-4.17 0.63-4.7z" fill="#FF8F00"/></g><g opacity=".2"><linearGradient id="b" x1="61.306" x2="5.3725" y1="68.743" y2="121.18" gradientUnits="userSpaceOnUse"><stop stop-color="#8D6E63" offset=".0035077"/><stop stop-color="#6D4C41" offset="1"/></linearGradient><path d="m33.91 55.74c6.94 0 17.85 7.74 25.04 14.94 5.89 5.89 10.53 12.27 13.06 17.96 2.44 5.5 2.12 8.64 1.11 9.65-0.05 0.05-0.13 0.11-0.23 0.19-0.05 0.04-0.1 0.07-0.14 0.11-0.07 0.03-0.13 0.06-0.19 0.09-0.19 0.09-0.4 0.17-0.63 0.22-0.1 0.02-0.2 0.05-0.29 0.09l-61.17 21.91c-0.18 0.06-0.36 0.1-0.53 0.1-0.47 0-0.93-0.25-1.22-0.66-0.2-0.28-0.39-0.75-0.17-1.36l22.11-61.71c0.18-0.15 0.35-0.33 0.49-0.53 0.07-0.1 0.14-0.18 0.19-0.23 0.5-0.51 1.37-0.77 2.57-0.77m0-3c-1.97 0-3.58 0.53-4.7 1.65-0.18 0.18-0.34 0.38-0.49 0.59l-0.32-0.32-22.68 63.3c-1.1 3.06 1.27 6.04 4.22 6.04 0.5 0 1.02-0.09 1.54-0.27l61.15-21.91c0.44-0.11 0.85-0.25 1.23-0.44l0.93-0.33-0.14-0.14c0.21-0.15 0.41-0.31 0.59-0.49 4.88-4.88-1.46-19.15-14.17-31.86-9.8-9.81-20.53-15.82-27.16-15.82z" fill="url(#b)"/></g><ellipse transform="matrix(.7071 -.7071 .7071 .7071 -39.433 59.598)" cx="52.22" cy="77.4" rx="12.74" ry="33.15" fill="#795548"/><g opacity=".2"><path d="m33.57 55.28c7.08 0 18.21 7.89 25.54 15.23 13.01 13.01 17.24 25.4 14.43 28.2-0.53 0.53-1.43 0.8-2.66 0.8-7.09 0-18.21-7.89-25.54-15.23-13.01-13.01-17.24-25.4-14.43-28.2 0.53-0.53 1.42-0.8 2.66-0.8m0-3c-2.01 0-3.64 0.54-4.78 1.68-4.97 4.97 1.49 19.5 14.43 32.45 9.98 9.98 20.91 16.11 27.66 16.11 2.01 0 3.64-0.54 4.78-1.68 4.97-4.97-1.49-19.5-14.43-32.45-9.98-9.98-20.9-16.11-27.66-16.11z" fill="#424242"/></g><polygon points="104 30.92 99.85 25 108.97 18.61 111.86 22.73" fill="#1E88E5"/><polygon points="11.75 16.74 18.47 15.49 20.39 25.85 15.71 26.72" fill="#FF5722"/><polygon points="61.17 13.31 54.8 14.98 52.22 5.16 56.65 4" fill="#1E88E5"/><path d="m60.83 95.45c3.1-7.97 8.61-12.19 17.53-12.3 9.08-0.11 23.89 5.35 24.6 16.07 0-1.64 0-3.27 0.01-4.91-0.7 3.91-4.75 5.54-8.42 4.7-3.9-0.89-6.46-4.17-6.96-8.02 0 1.64 0 3.27 0.01 4.91 0.41-8.89 9.96-11.79 17.47-11.68 7.84 0.12 13.44 5.39 17.73 11.45-0.77-1.09 0.8-3.87 0-5-4.51-6.36-10.34-11.61-18.57-11.46-6.69 0.13-15.43 2.68-16.58 10.35-0.39 2.62-0.48 6.55 0.51 9.02 2.03 5.09 12.11 8.84 14.58 1.99 3.56-9.87-6.38-18.08-14.62-20.79-6.16-2.02-13.22-2.44-19.21 0.42-4.45 2.13-6.38 5.85-8.09 10.24-0.56 1.47 0.56 3.58 0.01 5.01z" fill="#FF5722"/><path d="m71.16 65.22c3.5 1.86 7.48 4.44 11.45 2.32 2.29-1.23 3.47-3.57 4.44-5.87 2.22-5.25 3.25-8.25 9.34-5.45 3.58 1.64 11.87 7.07 13.38 0.12 0.78-3.61-0.5-7.45-0.69-11 0 1.64 0 3.27-0.01 4.91 0.91-6.28 10.05-4.1 13.91-2.43-0.58-0.25 0.64-4.72 0-5-4.17-1.81-13.12-3.8-13.92 2.77-0.4 3.29 0.42 6.5 0.76 9.73 0-1.64 0-3.27-0.01-4.91-0.56 11.37-15.22-3.27-19.74 0.15-2.51 1.9-2.8 6.55-4.49 9.09-3.8 5.73-9.4 3.26-14.43 0.58 0.67 0.34-0.71 4.61 0.01 4.99z" fill="#1E88E5"/><path d="m32.79 61.81c6.64-0.72 8.01-7.46 6.97-13.04-1.49-8.01-13.26-8.73-14-16.54 0 1.64 0 3.27 0.01 4.91 0.24-4.21 3.5-7.19 6.93-9.13 3.18-1.79 4.95-3.96 5.37-7.81 0.59-5.5-1.21-9.32-6.26-12.17 0.69 0.39-0.74 4.58 0 5 2.52 1.42 5.95 4.07 6.26 7.17v-5c-1.12 6.35-4.44 6.26-8.53 9.91-3.08 2.75-3.8 5.76-3.8 9.62 0 3.69 0.89 6.05 3.99 8.44 4.28 3.29 9.11 5.33 10.13 11.23 0-1.64 0-3.27-0.01-4.91-0.19 4.14-3.06 6.89-7.07 7.32-0.21 0.02 0.15 4.98 0.01 5z" fill="#1E88E5"/><path d="m43.73 80.2c5.3 2.27 12.95-2.87 14.41-7.96 0.73-2.53 0.78-6.18 0.44-8.8-0.48-3.71-3.58-6.08-4.94-9.42-1.09-2.68-0.45-4.97 1.1-7.86 2.5-4.65 13.7-11.7 15.52-2.67 0-1.55-0.01-3.11-0.01-4.66-0.04 2.86-1.76 5.08-4.8 4.49-2.96-0.57-4.25-3.27-4.64-5.96 0.01 1.42 0.01 2.85 0.02 4.27 0.16-12.17 13.35-16.69 23.37-17.33 0.14-0.01-0.07-5 0-5-12.76 0.81-23.41 6.79-23.41 20.56 0 3.68 1.02 9.04 5.96 8.56 4.04-0.39 3.64-5.1 3.54-8.1-0.14-4.15-2.95-7.01-7.49-5.9-5.2 1.28-8.7 6.36-9.73 11.35-0.55 2.66-0.48 5.59-0.35 8.3 0.26 5.77 4.96 9.01 5.86 14.36 0-1.64 0-3.27-0.01-4.91-0.3 4.27-1.71 7.38-5.45 9.87-2.54 1.69-6.42 3.07-9.4 1.79 0.58 0.26-0.63 4.75 0.01 5.02z" fill="#FF5722"/></svg>
<!-- U+1F389 Party Popper, from NotoColorEmoji; https://github.com/googlefonts/noto-emoji/blob/master/svg/emoji_u1f389.svg -->
<button id="zzback" hidden>عودة</button>
</div>

<!-- these svg arrows were designed in Inkscape by me and optimized with https://vecta.io/nano -->
<div id="mvbtns" hidden>
  <button title="أخف آية (زري Ctrl+BackSpace)" id="prevaaya"><svg viewBox="0 0 250 200" height="1000" width="1000"><path d="M195.826 237.711h-39.765l60.864-105.419-60.864-105.419h39.765l60.864 105.419zm-68.792 0H87.269l60.864-105.419-60.864-105.42h39.765l60.864 105.419zm-68.792 0H18.477l60.864-105.419-60.864-105.42h39.765l60.864 105.419z"/></svg></button>
  <button title="أخف عبارة - حتى علامة وقف أو نهاية آية (زر رقم الواحد)" id="prevjmla"><svg viewBox="0 0 250 200" height="1000" width="1000"><path d="M161.43 237.711h-39.765l60.864-105.419-60.864-105.419h39.765l60.864 105.419zm-68.792 0H52.873l60.864-105.419-60.864-105.42h39.765l60.864 105.419z"/></svg></button>
  <button title="أخف كلمة (زر BackSpace أو سهم يمين)" id="prevword"><svg viewBox="0 0 250 200" height="1000" width="1000"><path d="M127.034 237.711H87.269l60.864-105.419L87.269 26.872h39.765l60.864 105.419z"/></svg></button>
  <button title="أظهر كلمة (زر Space أو Enter أو سهم يسار)" id="nextword"><svg viewBox="0 0 250 200" height="1000" width="1000"><path d="M137.549 237.711h39.765l-60.864-105.419 60.864-105.419h-39.765L76.686 132.292z"/></svg></button>
  <button title="أظهر عبارة - حتى علامة وقف أو نهاية آية (زر رقم الصفر)" id="nextjmla"><svg viewBox="0 0 250 200" height="1000" width="1000"><path d="M103.154 237.711h39.765L82.055 132.292l60.864-105.419h-39.765L42.29 132.292zm68.791 0h39.765l-60.864-105.419 60.864-105.42h-39.765l-60.864 105.419z"/></svg></button>
  <button title="أظهر آية (زري Ctrl+Space أو Ctrl+Enter)" id="nextaaya"><svg viewBox="0 0 250 200" height="1000" width="1000"><path d="M68.758 237.711h39.765L47.659 132.292l60.864-105.419H68.758L7.894 132.292zm68.791 0h39.765L116.45 132.292l60.864-105.419h-39.765L76.685 132.292zm68.792 0h39.765l-60.864-105.419 60.864-105.419h-39.765l-60.864 105.419z"/></svg></button>
</div>


</div>
</div>

<script src="res/jszip.min.js"></script>

<script>
    window.goatcounter = {
        path: location.href,
        allow_frame: true,
        allow_local: true,
    }
</script>
<!-- privacy-friendly statistics, no tracking of personal data, no need for GDPR consent; see goatcounter.com -->
<script data-goatcounter="https://noureddin.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>

<script>
'use strict';

// I know that the JS naming convention is to use lowerCamelCase for variables
// and functions. But I decided to use snake_case exclusively to make my
// functions visually distinct from those of JS, especially b/c I have functions
// with similar names, eg scroll_to_top. I also use it for variables and consts.
// The only exception is the following two shorthand functions.

const say = console.log

// Q, Qid, el_*, data {{{
function Q    (selector) { return document.querySelector(selector) }
function Qall (selector) { return document.querySelectorAll(selector) }
function Qid  (id)       { return document.getElementById(id) }

const el_dark = Qid("dark")
const el_body = Qid("body")
const el_all = Qid("all")
const el_help = Qid("help")
const el_helptoggle = Qid("helptoggle")
const el_optiontoggle = Qid("optiontoggle")
const el_options = Qid("options")
const el_darkmode_option = Qid("darkmode_option")
const el_darkmode_input = Qid("darkmode_input")
const el_teacher_option = Qid("teacher_option")
const el_teacher_input = Qid("teacher_input")
const el_qaris = Qid("qaris")
const el_qariurl = Qid("qariurl")
const el_guide = Qid("guide")
const el_quizmode_option = Qid("quizmode_option")
const el_quizmode = Qid("quizmode")
const el_uthm_options = Qid("uthm_options")
const el_uthm_options_title = Qid("uthm_options_title")
const el_mvbtns_input = Qid("mvbtns_input")
const el_textclr_input = Qid("textclr_input")
const el_ayatnum_input = Qid("ayatnum_input")
const el_imla_options = Qid("imla_options")
const el_imla_options_title = Qid("imla_options_title")
const el_feedbackrate = Qid("feedbackrate")
const el_helpcontent = Qid("helpcontent")
const el_player = Qid("player")
const el_title = Qid("title")
const el_selectors = Qid("selectors")
const el_sura_bgn = Qid("sura_bgn")
const el_aaya_bgn = Qid("aaya_bgn")
const el_sura_end = Qid("sura_end")
const el_aaya_end = Qid("aaya_end")
const el_ok = Qid("ok")
const el_header = Qid("header")
const el_zzignore = Qid("zzignore")
const el_new = Qid("new")
const el_repeat = Qid("repeat")
const el_end_of_header = Qid("end_of_header")
const el_uthm_txt = Qid("uthm_txt")
const el_imla_txt = Qid("imla_txt")
const el_endmsg = Qid("endmsg")
const el_zzback = Qid("zzback")
const el_mvbtns = Qid("mvbtns")
const el_prevaaya = Qid("prevaaya")
const el_prevjmla = Qid("prevjmla")
const el_prevword = Qid("prevword")
const el_nextword = Qid("nextword")
const el_nextjmla = Qid("nextjmla")
const el_nextaaya = Qid("nextaaya")


const suar_length = [7,286,200,176,120,165,206,75,129,109,123,111,43,52,99,128,111,110,98,135,112,78,118,64,77,227,93,88,69,60,34,30,73,54,45,83,182,88,75,85,54,53,89,59,37,35,38,29,18,45,60,49,62,55,78,96,29,22,24,13,14,11,11,18,12,12,30,52,52,44,28,28,20,56,40,31,50,40,46,42,29,19,36,25,22,17,19,26,30,20,15,21,11,8,8,19,5,8,8,11,11,8,3,9,5,4,7,3,6,3,5,4,5,6]
const suar_name = ['الفاتحة','البقرة','آل عمران','النساء','المائدة','الأنعام','الأعراف','الأنفال','التوبة','يونس','هود','يوسف','الرعد','إبراهيم','الحجر','النحل','الإسراء','الكهف','مريم','طه','الأنبياء','الحج','المؤمنون','النور','الفرقان','الشعراء','النمل','القصص','العنكبوت','الروم','لقمان','السجدة','الأحزاب','سبأ','فاطر','يس','الصافات','ص','الزمر','غافر','فصلت','الشورى','الزخرف','الدخان','الجاثية','الأحقاف','محمد','الفتح','الحجرات','ق','الذاريات','الطور','النجم','القمر','الرحمن','الواقعة','الحديد','المجادلة','الحشر','الممتحنة','الصف','الجمعة','المنافقون','التغابن','الطلاق','التحريم','الملك','القلم','الحاقة','المعارج','نوح','الجن','المزمل','المدثر','القيامة','الإنسان','المرسلات','النبأ','النازعات','عبس','التكوير','الانفطار','المطففين','الانشقاق','البروج','الطارق','الأعلى','الغاشية','الفجر','البلد','الشمس','الليل','الضحى','الشرح','التين','العلق','القدر','البينة','الزلزلة','العاديات','القارعة','التكاثر','العصر','الهمزة','الفيل','قريش','الماعون','الكوثر','الكافرون','النصر','المسد','الإخلاص','الفلق','الناس',]
// both rubs and pages are based on http://tanzil.net/res/text/metadata/quran-data.js
// but changed from sura-aya pairs to aya indexes (0-6235)
const rubs = [0,32,50,66,81,98,112,130,148,164,183,195,209,225,239,249,259,269,278,289,307,325,344,367,385,405,425,445,463,478,493,504,516,528,550,566,580,592,606,627,640,655,669,680,695,709,719,735,750,765,777,801,824,847,862,883,899,915,929,939,954,984,1000,1018,1041,1070,1095,1109,1124,1142,1160,1181,1200,1220,1235,1253,1268,1280,1294,1309,1327,1345,1356,1374,1389,1416,1434,1453,1478,1496,1513,1533,1556,1580,1602,1625,1648,1672,1696,1711,1725,1741,1759,1777,1802,1851,1901,1930,1951,1975,1990,2011,2029,2051,2078,2098,2127,2156,2171,2190,2214,2238,2271,2308,2348,2402,2430,2458,2483,2511,2533,2565,2595,2613,2632,2654,2673,2708,2747,2791,2811,2825,2843,2855,2875,2907,2932,2983,3042,3112,3159,3185,3214,3240,3263,3280,3302,3327,3340,3365,3385,3409,3439,3462,3490,3513,3533,3550,3563,3583,3592,3615,3629,3651,3674,3700,3732,3764,3809,3870,3932,3990,4021,4065,4089,4110,4133,4153,4173,4198,4226,4242,4264,4284,4298,4322,4348,4381,4430,4484,4510,4530,4554,4577,4600,4612,4625,4656,4705,4758,4809,4854,4901,4979,5053,5090,5104,5117,5136,5156,5177,5191,5217,5229,5241,5271,5323,5393,5447,5494,5551,5609,5672,5758,5829,5884,5948,6023,6090,6154,6236]
const pages = [0,7,12,23,31,36,44,55,64,68,76,83,90,95,100,108,112,119,126,133,141,148,152,160,170,176,183,188,193,197,203,209,217,222,226,231,237,240,244,252,255,259,263,266,271,276,281,288,289,293,302,308,315,322,330,338,345,354,363,370,376,384,393,401,408,414,425,433,441,446,450,458,466,473,479,487,493,499,504,507,512,516,519,526,530,537,544,552,558,567,572,579,584,587,594,598,606,614,620,627,633,640,647,655,663,668,671,674,678,682,686,692,700,705,710,714,719,726,733,739,745,751,758,764,772,777,782,789,797,807,816,824,833,841,848,857,862,870,879,883,890,899,907,913,920,926,931,935,940,946,954,965,976,984,991,997,1005,1011,1021,1027,1035,1041,1049,1058,1074,1084,1091,1097,1103,1109,1113,1117,1124,1132,1141,1149,1160,1168,1176,1185,1193,1200,1205,1212,1221,1229,1235,1241,1248,1255,1261,1266,1271,1275,1282,1289,1296,1303,1307,1314,1321,1328,1334,1341,1346,1352,1357,1364,1370,1378,1384,1389,1397,1406,1417,1425,1434,1442,1452,1461,1470,1478,1485,1492,1501,1510,1518,1526,1535,1544,1554,1561,1570,1581,1590,1600,1610,1618,1626,1633,1639,1648,1659,1665,1674,1682,1691,1699,1707,1712,1720,1725,1735,1741,1749,1755,1760,1768,1774,1783,1792,1802,1817,1833,1853,1872,1892,1907,1915,1927,1935,1943,1955,1965,1973,1980,1988,1994,2003,2011,2019,2029,2036,2046,2056,2067,2078,2087,2095,2104,2115,2125,2133,2144,2155,2160,2167,2174,2185,2193,2201,2214,2223,2237,2250,2261,2275,2288,2301,2314,2326,2345,2360,2385,2399,2412,2424,2435,2446,2461,2473,2483,2493,2507,2518,2527,2540,2555,2564,2573,2584,2595,2600,2610,2618,2625,2633,2641,2650,2659,2667,2673,2690,2700,2715,2732,2747,2762,2777,2791,2801,2811,2818,2822,2827,2834,2844,2849,2852,2857,2866,2875,2887,2898,2910,2922,2932,2951,2971,2992,3015,3043,3068,3091,3115,3138,3159,3172,3181,3194,3203,3214,3222,3235,3247,3257,3265,3273,3280,3287,3295,3302,3311,3322,3329,3336,3346,3354,3363,3370,3378,3385,3392,3403,3414,3424,3433,3441,3450,3459,3469,3480,3488,3497,3503,3514,3523,3533,3539,3548,3555,3563,3568,3576,3583,3587,3595,3606,3613,3620,3628,3637,3645,3654,3663,3671,3678,3690,3698,3704,3717,3732,3745,3759,3775,3788,3812,3839,3864,3890,3914,3941,3970,3986,3996,4012,4031,4053,4063,4068,4079,4089,4098,4105,4114,4125,4132,4140,4149,4158,4166,4173,4182,4191,4199,4210,4218,4229,4238,4247,4256,4264,4272,4282,4287,4294,4303,4316,4323,4335,4347,4358,4372,4385,4398,4414,4432,4453,4473,4486,4495,4505,4515,4524,4530,4538,4545,4556,4564,4574,4583,4592,4598,4606,4611,4616,4623,4630,4645,4665,4681,4705,4726,4749,4766,4784,4810,4828,4852,4873,4895,4917,4941,4968,4995,5029,5055,5078,5086,5093,5099,5104,5110,5115,5125,5129,5135,5142,5150,5155,5161,5168,5177,5185,5192,5199,5208,5217,5222,5229,5236,5241,5253,5267,5286,5313,5331,5357,5385,5414,5429,5447,5460,5475,5494,5512,5542,5570,5596,5616,5641,5672,5702,5727,5758,5800,5829,5854,5882,5909,5931,5963,5993,6016,6043,6072,6098,6125,6137,6155,6176,6193,6207,6221,6236]
// from tanzil metadata too, but in a more compact format
const rukus = [[1],[1,8,21,30,40,47,60,62,72,83,87,97,104,113,122,130,142,148,153,164,168,177,183,189,197,211,217,222,229,232,236,243,249,254,258,261,267,274,282,284],[1,10,21,31,42,55,64,72,81,92,102,110,121,130,144,149,156,172,181,190],[1,11,15,23,26,34,43,51,60,71,77,88,92,97,101,105,113,116,127,135,142,153,163,172],[1,6,12,20,27,35,44,51,57,67,78,87,94,101,109,116],[1,11,21,31,42,51,56,61,71,83,91,95,101,111,122,130,141,145,151,155],[1,11,26,32,40,48,54,59,65,73,85,94,100,109,127,130,142,148,152,158,163,172,182,189],[1,11,20,29,38,45,49,59,65,70],[1,7,17,25,30,38,43,60,67,73,81,90,100,111,119,123],[1,11,21,31,41,54,61,71,83,93,104],[1,9,25,36,50,61,69,84,96,110],[1,7,21,30,36,43,50,58,69,80,94,105],[1,8,19,27,32,38],[1,7,13,22,28,35,42],[1,16,26,45,61,80],[1,10,22,26,35,41,51,61,66,71,77,84,90,101,111,120],[1,11,23,31,41,53,61,71,78,85,94,101],[1,13,18,23,32,45,50,54,60,71,83,102],[1,16,41,51,66,83],[1,25,55,77,90,105,116,129],[1,11,30,42,51,76,94],[1,11,23,26,34,39,49,58,65,73],[1,23,33,51,78,93],[1,11,21,27,35,41,51,58,62],[1,10,21,35,45,61],[1,10,34,53,70,105,123,141,160,176,192],[1,15,32,45,59,67,83],[1,14,22,29,43,51,61,76],[1,14,23,31,45,52,64],[1,11,20,28,41,54],[1,12,20],[1,12,23],[1,9,21,28,35,41,53,59,69],[1,10,22,31,37,46],[1,8,15,27,38],[1,13,33,51,68],[1,22,75,114,139],[1,15,27,41,65],[1,10,22,32,42,53,64,71],[1,10,21,28,38,51,61,69,79],[1,9,19,26,33,45],[1,10,20,30,44],[1,16,26,36,46,57,68],[1,30,43],[1,12,22,27],[1,11,21,27],[1,12,20,29],[1,11,18,27],[1,11],[1,16,30],[1,24,47],[1,29],[1,26,33],[1,23,41],[1,26,46],[1,39,75],[1,11,20,26],[1,7,14],[1,11,18],[1,7],[1,10],[1,9],[1,9],[1,11],[1,8],[1,8],[1,15],[1,34],[1,38],[1,36],[1,21],[1,20],[1,20],[1,32],[1,31],[1,23],[1,41],[1,31],[1,27],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1],[1]]

function start_ (s) { return +suar_length.slice(0, s).reduce((a, b) => a + b, 0) }

// TODO see: https://stackoverflow.com/q/10726638

function filter_aaya_input (n) {  // remove non-numerals and convert numerals to Eastern Arabic
  return n.toString()
      .replace(/[0٠]/g, '٠')
      .replace(/[1١]/g, '١')
      .replace(/[2٢]/g, '٢')
      .replace(/[3٣]/g, '٣')
      .replace(/[4٤]/g, '٤')
      .replace(/[5٥]/g, '٥')
      .replace(/[6٦]/g, '٦')
      .replace(/[7٧]/g, '٧')
      .replace(/[8٨]/g, '٨')
      .replace(/[9٩]/g, '٩')
      .replace(/[^٠١٢٣٤٥٦٧٨٩]/g, '')
}
function defilter_aaya_input (n) {  // convert numerals to ASCII
  return n
      .replace(/٠/g, '0')
      .replace(/١/g, '1')
      .replace(/٢/g, '2')
      .replace(/٣/g, '3')
      .replace(/٤/g, '4')
      .replace(/٥/g, '5')
      .replace(/٦/g, '6')
      .replace(/٧/g, '7')
      .replace(/٨/g, '8')
      .replace(/٩/g, '9')
}

const sura_bgn_length = () => el_sura_bgn.value === ''? 0  :         suar_length[+el_sura_bgn.value]
const sura_end_length = () => el_sura_end.value === ''? 0  :         suar_length[+el_sura_end.value]
const sura_bgn_val    = () => el_sura_bgn.value === ''? '' :                     +el_sura_bgn.value
const sura_end_val    = () => el_sura_end.value === ''? '' :                     +el_sura_end.value
const aaya_bgn_val    = () => el_aaya_bgn.value === ''? '' : +defilter_aaya_input(el_aaya_bgn.value)
const aaya_end_val    = () => el_aaya_end.value === ''? '' : +defilter_aaya_input(el_aaya_end.value)


// }}}

// validate_aaya_sura_input {{{
// called oninput and onblur with the element; only called for {sura,aaya}_{bgn,end} inputs.
// sometimes updates the input fields. and enables #ok if the inputs are valid.
function validate_aaya_sura_input (ev) {
  const el = ev.target
  const blur = ev.type === 'blur'
  const is_aaya = el === el_aaya_bgn || el === el_aaya_end

  el_aaya_bgn.value = filter_aaya_input(el_aaya_bgn.value)
  el_aaya_end.value = filter_aaya_input(el_aaya_end.value)

  if (blur && is_aaya && el.value === '') {
    if (el === el_aaya_bgn) {
      if (el_sura_bgn.value !== '') { el.value = 0 }
    }
    else {  // el === el_aaya_end
      if (el_sura_end.value !== '') { el.value = 300 }
    }
  }

  const set_aaya_bgn = (n) => el_aaya_bgn.value = filter_aaya_input(+n)
  const set_aaya_end = (n) => el_aaya_end.value = filter_aaya_input(+n)

  // if the changed field is sura_bgn, make aaya_bgn 1 if empty,
  // and update sura_end if empty or is before sura_bgn
  if (!blur && el === el_sura_bgn) {
    if (aaya_bgn_val() === '') { set_aaya_bgn(1) }
    if (sura_end_val() === '' || sura_end_val() < sura_bgn_val()) {
      el_sura_end.value = sura_bgn_val()
      set_aaya_end(sura_end_length())
    }
  }
  // if the changed field is sura_end, make aaya_end the last aya,
  // and update sura_bgn if empty or is after sura_end
  else if (!blur && el === el_sura_end) {
    set_aaya_end(sura_end_length())
    if (sura_bgn_val() === '' || (sura_end_val() !== '' && sura_end_val() < sura_bgn_val())) {
      el_sura_bgn.value = sura_end_val()
      set_aaya_bgn(1)
    }
  }

  // make sure ayat are within limits:

  // ayat upper-limits:
  if (aaya_bgn_val() > sura_bgn_length()) { set_aaya_bgn(sura_bgn_length()) }
  if (aaya_end_val() > sura_end_length()) { set_aaya_end(sura_end_length()) }

  // ayat lower-limits:
  if (aaya_bgn_val() === 0) { set_aaya_bgn(1) }
  if (aaya_end_val() === 0) { set_aaya_end(1) }
  // '' is checked for in the onblur case above
  // a negative sign is not allowed to be entered

  if (sura_bgn_val() !== '' && sura_end_val() !== '' &&
      aaya_bgn_val() !== '' && aaya_end_val() !== ''
  ) {
    // console.log('valid', sura_bgn_val(), sura_end_val(), aaya_bgn_val(), aaya_end_val())
    el_ok.disabled = false
  }
  else {
    // console.log('invalid')
    el_ok.disabled = true
  }
}
// }}}

// from: https://github.com/mathusummut/confetti.js
// Copyright (c) 2018 MathuSum Mut. MIT License
var confetti={maxCount:150,speed:2,frameInterval:15,alpha:1,gradient:!1,start:null,stop:null,toggle:null,pause:null,resume:null,togglePause:null,remove:null,isPaused:null,isRunning:null};!function(){confetti.start=s,confetti.stop=w,confetti.toggle=function(){e?w():s()},confetti.pause=u,confetti.resume=m,confetti.togglePause=function(){i?m():u()},confetti.isPaused=function(){return i},confetti.remove=function(){stop(),i=!1,a=[]},confetti.isRunning=function(){return e};var t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame,n=["rgba(30,144,255,","rgba(107,142,35,","rgba(255,215,0,","rgba(255,192,203,","rgba(106,90,205,","rgba(173,216,230,","rgba(238,130,238,","rgba(152,251,152,","rgba(70,130,180,","rgba(244,164,96,","rgba(210,105,30,","rgba(220,20,60,"],e=!1,i=!1,o=Date.now(),a=[],r=0,l=null;function d(t,e,i){return t.color=n[Math.random()*n.length|0]+(confetti.alpha+")"),t.color2=n[Math.random()*n.length|0]+(confetti.alpha+")"),t.x=Math.random()*e,t.y=Math.random()*i-i,t.diameter=10*Math.random()+5,t.tilt=10*Math.random()-10,t.tiltAngleIncrement=.07*Math.random()+.05,t.tiltAngle=Math.random()*Math.PI,t}function u(){i=!0}function m(){i=!1,c()}function c(){if(!i)if(0===a.length)l.clearRect(0,0,window.innerWidth,window.innerHeight),null;else{var n=Date.now(),u=n-o;(!t||u>confetti.frameInterval)&&(l.clearRect(0,0,window.innerWidth,window.innerHeight),function(){var t,n=window.innerWidth,i=window.innerHeight;r+=.01;for(var o=0;o<a.length;o++)t=a[o],!e&&t.y<-15?t.y=i+100:(t.tiltAngle+=t.tiltAngleIncrement,t.x+=Math.sin(r)-.5,t.y+=.5*(Math.cos(r)+t.diameter+confetti.speed),t.tilt=15*Math.sin(t.tiltAngle)),(t.x>n+20||t.x<-20||t.y>i)&&(e&&a.length<=confetti.maxCount?d(t,n,i):(a.splice(o,1),o--))}(),function(t){for(var n,e,i,o,r=0;r<a.length;r++){if(n=a[r],t.beginPath(),t.lineWidth=n.diameter,i=n.x+n.tilt,e=i+n.diameter/2,o=n.y+n.tilt+n.diameter/2,confetti.gradient){var l=t.createLinearGradient(e,n.y,i,o);l.addColorStop("0",n.color),l.addColorStop("1.0",n.color2),t.strokeStyle=l}else t.strokeStyle=n.color;t.moveTo(e,n.y),t.lineTo(i,o),t.stroke()}}(l),o=n-u%confetti.frameInterval),requestAnimationFrame(c)}}function s(t,n,o){var r=window.innerWidth,u=window.innerHeight;window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,confetti.frameInterval)};var m=document.getElementById("confetti-canvas");null===m?((m=document.createElement("canvas")).setAttribute("id","confetti-canvas"),m.setAttribute("style","display:block;z-index:999999;pointer-events:none;position:fixed;top:0"),document.body.prepend(m),m.width=r,m.height=u,window.addEventListener("resize",function(){m.width=window.innerWidth,m.height=window.innerHeight},!0),l=m.getContext("2d")):null===l&&(l=m.getContext("2d"));var s=confetti.maxCount;if(n)if(o)if(n==o)s=a.length+o;else{if(n>o){var f=n;n=o,o=f}s=a.length+(Math.random()*(o-n)+n|0)}else s=a.length+n;else o&&(s=a.length+o);for(;a.length<s;)a.push(d({},r,u));e=!0,i=!1,c(),t&&window.setTimeout(w,t)}function w(){e=!1}}();


!function(e){"object"==typeof exports?module.exports=e():"function"==typeof define&&define.amd?define(e):"undefined"!=typeof window?window.JSZipUtils=e():"undefined"!=typeof global?global.JSZipUtils=e():"undefined"!=typeof self&&(self.JSZipUtils=e())}(function(){return function o(i,f,u){function s(n,e){if(!f[n]){if(!i[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(a)return a(n,!0);throw new Error("Cannot find module '"+n+"'")}var r=f[n]={exports:{}};i[n][0].call(r.exports,function(e){var t=i[n][1][e];return s(t||e)},r,r.exports,o,i,f,u)}return f[n].exports}for(var a="function"==typeof require&&require,e=0;e<u.length;e++)s(u[e]);return s}({1:[function(e,t,n){"use strict";var u={};function r(){try{return new window.XMLHttpRequest}catch(e){}}u._getBinaryFromXHR=function(e){return e.response||e.responseText};var s="undefined"!=typeof window&&window.ActiveXObject?function(){return r()||function(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}()}:r;u.getBinaryContent=function(t,n){var e,r,o,i;"function"==typeof(n=n||{})?(i=n,n={}):"function"==typeof n.callback&&(i=n.callback),i||"undefined"==typeof Promise?(r=function(e){i(null,e)},o=function(e){i(e,null)}):e=new Promise(function(e,t){r=e,o=t});try{var f=s();f.open("GET",t,!0),"responseType"in f&&(f.responseType="arraybuffer"),f.overrideMimeType&&f.overrideMimeType("text/plain; charset=x-user-defined"),f.onreadystatechange=function(e){if(4===f.readyState)if(200===f.status||0===f.status)try{r(u._getBinaryFromXHR(f))}catch(e){o(new Error(e))}else o(new Error("Ajax error for "+t+" : "+this.status+" "+this.statusText))},n.progress&&(f.onprogress=function(e){n.progress({path:t,originalEvent:e,percent:e.loaded/e.total*100,loaded:e.loaded,total:e.total})}),f.send()}catch(e){o(new Error(e),null)}return e},t.exports=u},{}]},{},[1])(1)});


const audio = (function () {  // {{{
  const el_player = Qid('player')
  let list
  let base_url
  let cur_idx

  function index (i) { return i != null ? i : cur_idx }

  function invalid_state (idx) {
    idx = index(idx)
    return idx == null || idx < 0 || !base_url || !list || idx >= list.length
  }

  function audio_url (idx) {
    idx = index(idx)
    if (invalid_state(idx)) { return }
    return base_url + list[idx] + '.mp3'
  }

  function fetch (idx) {
    idx = index(idx)
    if (invalid_state(idx)) { return }
    new Audio(audio_url(idx))
  }

  function play () {
    if (invalid_state()) { return }
    // el_title.innerText = list[cur_idx]  // for debugging
    el_player.src = audio_url()
    el_player.addEventListener('loadeddata', () => fetch(cur_idx + 1))
    el_player.play()
  }

  function set_idx (i) { cur_idx = i; fetch() }

  function show_or_hide_player () {
    invalid_state() ? hide_el(el_player) : show_el(el_player)
  }

  function update_qari (qari) {
    base_url = qari? `https://www.everyayah.com/data/${qari}/` : undefined
    fetch()
  }

  return {

    update_qari: function (qari) {
      update_qari(qari)
      show_or_hide_player()
    },

    init: function (qari, qariurl) {
      update_qari(qari)
      if (!qari && qariurl) {
        base_url = qariurl.endsWith('/') ? qariurl : qariurl + '/'
      }
      set_idx(0)
    },

    fill: function (ayat) {
      list = ayat
      set_idx(0)
      show_or_hide_player()
    },

    play: function (idx) {
      if (idx != null) { set_idx(idx) }
      show_or_hide_player()
      play()
    },

    set_index: function (i) { set_idx(i) },
    next: function () { set_idx(cur_idx + 1) },
    back: function () { set_idx(cur_idx - 1) },

  }
})()

// }}}

// kind_of_portion is: 'a' on aaya boundary; 'j' on waqf boundary; '' otherwise. {{{
function kind_of_portion (last_two_chars) {
  const last_one_char = last_two_chars.slice(-1)
  return last_one_char  === ''  ? 'a' :  // start of text
         last_one_char  === '\n'? 'a' :  // end of aaya
         last_two_chars === '\u06DC\t'? 'j' :  // ARABIC SMALL HIGH SEEN
         last_two_chars === '\u06D6\t'? 'j' :  // ARABIC SMALL HIGH LIGATURE SAD WITH LAM WITH ALEF MAKSURA
         last_two_chars === '\u06D7\t'? 'j' :  // ARABIC SMALL HIGH LIGATURE QAF WITH LAM WITH ALEF MAKSURA
         last_two_chars === '\u06D8\t'? 'j' :  // ARABIC SMALL HIGH MEEM INITIAL FORM
         last_two_chars === '\u06DA\t'? 'j' :  // ARABIC SMALL HIGH JEEM
         last_two_chars === '\u06DB\t'? 'j' :  // ARABIC SMALL HIGH THREE DOTS
         ''
}  // }}}

function valid_inputs (sura_bgn, aaya_bgn, sura_end, aaya_end) {  // {{{
  return (
    sura_bgn !== '' && aaya_bgn !== '' &&
    sura_end !== '' && aaya_end !== '' &&
    sura_bgn <= sura_end &&
    (aaya_bgn <= aaya_end || sura_bgn < sura_end) &&
    1 <= aaya_bgn && aaya_bgn <= suar_length[sura_bgn] &&
    1 <= aaya_end && aaya_end <= suar_length[sura_end]
  )
}  // }}}

function chquizmode () {
  const show = (id) => Qid(id).style.display = 'block'
  const hide = (id) => Qid(id).style.display = 'none'
  if (!el_zzignore.hidden) { parent.zz_set_quizmode(el_quizmode.value) }
  if (el_quizmode.value === 'imla') {
    hide('uthm_options')
    show('imla_options')
  }
  else {  /* uthmani */
    hide('imla_options')
    show('uthm_options')
  }
}

function imlafilter_byword   (val) { return val.replace(/\S*$/, '') }  // only check after space or enter
function imlafilter_byletter (val) { return val }

window.imlafilter = imlafilter_byletter  // the default

function chfeedbackrate () {
  window.imlafilter = el_feedbackrate.value === "word"? imlafilter_byword : imlafilter_byletter
  if (!el_zzignore.hidden) { parent.zz_set_feedbackrate(el_feedbackrate.value) }
}

function chstyle () {
  const sync_class_with = (cls, pred) =>
    pred ? Q('body').classList.add(cls) : Q('body').classList.remove(cls)
  //
  const tval = Qid('textclr_input').value
  sync_class_with('letter-parts',   tval === 'bas')
  sync_class_with('letter-nocolor', tval === 'no')
  if (!el_zzignore.hidden) { parent.zz_set_tajweed(tval.slice(0,1)) }
  //
  sync_class_with('ayat-nocolor', !Qid('ayatnum_input').checked)
  //
  // sync_class_with('dark', Qid('darkmode_input').checked)
  let dark = Qid('dark').checked = Qid('darkmode_input').checked
  if (!el_zzignore.hidden) { parent.zz_set_dark(dark) }
  // mvbtns
  const mv = Qid('mvbtns_input').value
  const mv_cls =
    mv === 'right' ? 'sidebtns rightside' :
    mv === 'left'  ? 'sidebtns leftside'  :
                     ''  /* no class for 'bottom' */
  el_mvbtns.setAttribute('class', mv_cls)
  if (!el_zzignore.hidden) { parent.zz_set_mvbtns(mv.slice(0,1)) }
}

function decode_contact () {
  let xyz = Qid('xyz')
  let mia_nomo = Q('body').innerHTML.match(/github[.]com\/([a-z0-9]+)\//)[1]
  xyz.innerHTML = mia_nomo + String.fromCharCode(1<<6) + 'pro' + (''+(!![]))[+![]] + 'moc.liamno'.split('').reverse().join('')
  xyz.href = xyz.innerHTML.slice(16,20) + 'to' + String.fromCharCode('xyz'.charCodeAt(1<<1)^0O100) + xyz.innerHTML
  // if you know a better way, please let me know!
}

function make_title (sura_bgn, aaya_bgn, sura_end, aaya_end) {

  //// the longest strings (some are impossible):
  // return ["تسميع الآية الأخيرة من سورة العنكبوت", 'oneaaya']
  // return ["تسميع سورة العنكبوت كاملة", 'onesura']
  // return ["تسميع سورة العنكبوت من الآية الأخيرة حتى الآية الأخيرة", 'manyaaya']
  // return ["تسميع سورتي العنكبوت والعنكبوت كاملتين", 'twosura']
  // return ["تسميع السور من العنكبوت حتى العنكبوت", 'manysura']
  // return ["تسميع من سورة العنكبوت الآية الأخيرة حتى سورة العنكبوت الآية الأخيرة", 'manymany']
  // return ["تسميع الآيتين الأخيرة والأخيرة من سورة العنكبوت", 'twoaaya']

  const nbsp = '\xa0'
  // all numbers are 1-based
  sura_bgn = +sura_bgn
  aaya_bgn = +aaya_bgn
  sura_end = +sura_end
  aaya_end = +aaya_end
  const s_bgn_len = suar_length[sura_bgn - 1]
  const s_end_len = suar_length[sura_end - 1]
  const s_bgn_txt = suar_name[sura_bgn - 1]
  const s_end_txt = suar_name[sura_end - 1]
  // converts to Eastern Arabic numerals, and state the first and last in words
  const a_bgn_txt = aaya_bgn === 1? 'الأولى' : aaya_bgn === s_bgn_len? 'الأخيرة' : filter_aaya_input(aaya_bgn)
  const a_end_txt = aaya_end === 1? 'الأولى' : aaya_end === s_end_len? 'الأخيرة' : filter_aaya_input(aaya_end)
  //
  if (sura_bgn === sura_end) {
    // if exactly one aaya
    if (aaya_bgn === aaya_end) {
      return [`تسميع الآية${nbsp}${a_bgn_txt} من${nbsp}سورة${nbsp}${s_bgn_txt}`, '']
    }
    // if exactly two ayat
    if (aaya_end === aaya_bgn + 1) {
      return [`تسميع الآيتين${nbsp}${a_bgn_txt} و${a_end_txt} من${nbsp}سورة${nbsp}${s_bgn_txt}`, '']
    }
    // if one complete sura
    if (aaya_bgn === 1 && aaya_end === s_end_len) {
      return [`تسميع سورة ${s_bgn_txt} كاملة`, '']
    }
    // otherwise: one partial sura
    return [`تسميع سورة${nbsp}${s_bgn_txt} من${nbsp}الآية${nbsp}${a_bgn_txt} حتى${nbsp}الآية${nbsp}${a_end_txt}`, '']
  }
  // more than one sura:
  // if multiple complete suar
  if (aaya_bgn === 1 && aaya_end === s_end_len) {
    // if exactly two
    if (sura_end === sura_bgn + 1) {
      return [`تسميع سورتي ${s_bgn_txt} و${s_end_txt} كاملتين`, '']
    }
    // otherwise: more than two (one is handled previously)
    return [`تسميع السور من${nbsp}${s_bgn_txt} حتى${nbsp}${s_end_txt}`, '']
  }
  // otherwise
  return [`تسميع من${nbsp}سورة${nbsp}${s_bgn_txt} الآية${nbsp}${a_bgn_txt} حتى${nbsp}سورة${nbsp}${s_end_txt} الآية${nbsp}${a_end_txt}`, 'manymany']
}

// vim: set sw=2 ts=2 et fdm=marker colorcolumn=80:

// ligilumi: reading url parameters

const MAX_JUZ  = 30
const MAX_HIZB = 60
const MAX_RUB  = 240
const MAX_AYA  = 6236
const MAX_SURA = 114
const MAX_PAGE = 604
const MAX_RUKU = 556

function is_number (x) {
  return x == null ? x : !!x.match(/^[0-9]+$/)
}

function __paired (pair, sep) {  // auxiliary function for is_valid_pair
  const elems = pair.split(sep)
  return elems.length === 2 && elems.every(is_number)
}

function is_valid_pair (x) {  // a number, empty string, or two numbers separated by slash or double-slash
  return x === '' || is_number(x) || __paired(x, '//') || __paired(x, '/')
}

function range_to_pair (x) {
  let xs = x.split('-')
  if (!xs.every(is_valid_pair)) { return [null, null] }
  return xs.length === 2 ? xs : xs.length === 1 ? [x, x] : [null, null]
}

function suras_to_ayat (stsura, ensura) {  // each is 1-114
  if (!is_number(stsura) || !is_number(ensura)) { return [null, null] }
  stsura = +stsura || 1
  ensura = +ensura || MAX_SURA
  if (stsura < 1        || ensura < 1       ) { return [null, null] }
  if (stsura > MAX_SURA || ensura > MAX_SURA) { return [null, null] }
  const st = start_(stsura - 1) + 1
  const en = start_(ensura - 1) + suar_length[ensura - 1]
  return [st, en]
}

function idx2aya (idx) {  // 0-6235
  if (idx < 0 || idx > 6236) { return [null, null] }
  const s = [...Array(114).keys()].find(s => idx >= start_(s) && idx < start_(s + 1))
  return [s + 1, idx - start_(s) + 1]
}


function _aya2idx (aya) {  // 1-6236 or 1/7
  if (aya.includes('/')) {
    let a = aya.split('/');
    if (a.length !== 2) { return }
    if (+a[0] < 1 || +a[0] > MAX_SURA) { return }
    if (+a[1] < 1 || +a[1] > suar_length[+a[0] - 1]) { return }
    return start_(+a[0] - 1) + +a[1]
  }
  else {
    if (+aya > MAX_AYA) { return }
    return +aya
  }
}

function ayat_to_ayat (staya, enaya) {  // each is 1-6236 or 1/7 (sura/aya)
  if (!staya) { return [null, null] }
  let st = _aya2idx(staya)
  let en = _aya2idx(enaya)
  if (st == null || en == null) { return [null, null] }
  st = +st || 1; en = +en || MAX_AYA
  return [st, en]
}

function __sura_ruku__to__st_en (s, k) {
  if (k > rukus[s-1].length) { return null }
  const st = start_(s-1) + rukus[s-1][k-1]
  const en = k === rukus[s-1].length
    ? -1 + start_(s)   + rukus[s][0]    // next sura
    : -1 + start_(s-1) + rukus[s-1][k]  // same sura
  return [st, en]
}

function _ruku2idx (ruku) {  // each is 1/1 (sura/ruku) -- TODO: remove redundant computations
  if (ruku.includes('/')) {
    let k = ruku.split('/')
    if (k.length !== 2 || +k[0] > MAX_SURA) { return null }
    return __sura_ruku__to__st_en(+k[0], +k[1])
  }
  else {
    if (+ruku > MAX_RUKU) { return }
    for (let s = 0; s < MAX_SURA; ++s) {
      const max_sura_ruku = rukus[s].length
      for (let r = 0; r < max_sura_ruku; ++r) {
        ruku -= 1
        if (ruku === 0) { return __sura_ruku__to__st_en(s+1, r+1) }
      }
    }
  }
}

function rukus_to_ayat (struku, enruku) {  // each is 1/1 (sura/ruku)
  if (struku == null) { return [null, null] }
  let stpair = _ruku2idx(struku)
  let enpair = _ruku2idx(enruku)
  if (stpair == null || enpair == null) { return [null, null] }
  return [stpair[0], enpair[1]]
}

function pages_to_ayat (stpage, enpage) {  // each is 1-604
  if (stpage == null) { return [null, null] }
  stpage = +stpage || 1; enpage = +enpage || MAX_PAGE
  if (stpage > MAX_PAGE || enpage > MAX_PAGE) { return [null, null] }
  let st = pages[+stpage - 1] + 1
  let en = pages[+enpage]
  return [st, en]
}

function juzs_to_ayat (stjuz, enjuz) {  // each is 1-30
  if (stjuz == null) { return [null, null] }
  stjuz = +stjuz || 1
  enjuz = +enjuz || MAX_JUZ
  if (stjuz > MAX_JUZ || enjuz > MAX_JUZ) { return [null, null] }
  // we multiply by 8, as we have only data for rubs.
  const ratio = MAX_RUB / MAX_JUZ  // 8
  let st = rubs[((stjuz || 1)      - 1) * ratio] + 1
  let en = rubs[((enjuz || MAX_JUZ)   ) * ratio]
  return [st, en]
}

function __pair2idx (ratio, max, pair) {  // auxiliary function for _rub2idx() & _hizb2idx()
  if (pair.length !== 2) { return }
  if (+pair[0] < 1 || +pair[0] > max) { return }
  if (+pair[1] < 0 || +pair[1] > ratio) { return }
  return (+pair[0] - 1) * ratio + +pair[1] + 1
}

function _rub2idx (rub) {  // 1-240 or 1/1-60/4 or 1//1-30//8.
  // 30//8: [0] is juz, [1] is 1/8; i.e., it's the ([0]-1)*8+[1] 'th rub
  // 60/4: [0] is hizb, [1] is 1/4; i.e., it's the ([0]-1)*4+[1] 'th rub
  // 240: it's the nth rub
  // a rub is 1/4 of a hizb, and a hizb is 1/2 of a juz, thus a rub is 1/8 of a juz.
  if      (rub.includes('//')) { return __pair2idx(MAX_RUB / MAX_JUZ  /* 8 */, MAX_JUZ,  rub.split('//')) }
  else if (rub.includes('/'))  { return __pair2idx(MAX_RUB / MAX_HIZB /* 4 */, MAX_HIZB, rub.split('/'))  }
  else {
    if (+rub > MAX_RUB) { return }
    return +rub
  }
}

function rubs_to_ayat (strub, enrub) {  // each is 1-240 or 1/1-60/4 or 1//1-30//8.
  if (strub == null) { return [null, null] }
  const stidx = _rub2idx(strub)
  const enidx = _rub2idx(enrub)
  if (stidx == null || enidx == null) { return [null, null] }
  let st = rubs[(stidx || 1) - 1] + 1
  let en = rubs[ enidx || 240   ]
  return [st, en]
}

function _hizb2idx (hizb) {  // 1-60 or 1/1-30/2.
  // 30/2: [0] is juz, [1] is 1/2; i.e., it's the ([0]-1)*2+[1] 'th hizb
  // 60: it's the nth hizb
  // a rub is 1/4 of a hizb, and a hizb is 1/2 of a juz, thus a rub is 1/8 of a juz.
  if (hizb.includes('/')) { return __pair2idx(MAX_HIZB / MAX_JUZ /* 2 */, MAX_JUZ, hizb.split('/')) }
  else {
    if (+hizb > MAX_HIZB) { return }
    return +hizb
  }
}

function hizbs_to_ayat (sthizb, enhizb) {  // each is 1-240 or 1/1-60/4 or 1//1-30//8.
  if (sthizb == null) { return [null, null] }
  const stidx = _hizb2idx(sthizb)
  const enidx = _hizb2idx(enhizb)
  if (stidx == null || enidx == null) { return [null, null] }
  // we multiply by 4, as we have only data for rubs.
  const ratio = MAX_RUB / MAX_HIZB  // 4
  let st = rubs[((stidx || 1) - 1) * ratio] + 1
  let en = rubs[((enidx || 60)   ) * ratio]
  return [st, en]
}

const _color_values = {
  t: 'taj', taj: 'taj', tajweed: 'taj',
  b: 'bas', bas: 'bas', basic: 'bas',
  n: 'no',  no: 'no',   none: 'no',
}

function parse_color (color) {
  return _color_values[ color.toLowerCase() ]
}

const _quizmode_values = {
  i: 'imla', imla: 'imla', imlaai: 'imla',
  u: 'uthm', uthm: 'uthm', uthmani: 'uthm',
}

function parse_quizmode (quizmode) {
  return _quizmode_values[ quizmode.toLowerCase() ]
}

function parse_mv (mv) {
  mv = mv.toLowerCase()
  if (mv == ''
   || mv == 'b') { return 'bottom' }
  if (mv == 'r') { return 'right' }
  if (mv == 'l') { return 'left' }
}

function _ligilumilo (params) {
  let st; let en  // start aaya and end aaya
  // possible params:
  // - p: page. 1-604.
  // - s: sura, an entire sura. 1-114.
  // - j: juz,  an entire juz.  1-30.
  // - h: hizb, an entire hizb. 1-60  or 1/1-30/2.
  // - r: rub,  an entire rub.  1-240 or 1/1-60/4 or 1//1-30//8.
  // - k: ruku,  an entire ruku.
  // - ### => number of aaya in the Quran (1-6236)
  // - ##/### => number of sura and number of aaya in it
  //
  // all previous parameters can be paired; e.g., r=1-2 means to the end of the 2nd rub.
  //
  let a = 0; let b = 0
  // - b: before, a number of ayat to add before whatever you select. 0-inf.
  // - a: after,  a number of ayat to add before whatever you select. 0-inf.
  let dark             // dark mode: d/dark; l/light (default).
  let color = 'taj'    // color of text: c/color = t/taj/tajweed (default); b/bas/basic; n/no/none.
  let mv = 'bottom'    // position of buttons: m/mv/mvbtns = b (bottom; default); r (right); l (left).
  let quizmode         // quiz mode: q/qz/quizmode = u/uthm/uthmani (no-typing; default); i/imla/imlaai (typing)
  let byword           // imlaai-mode feedback rate; default); byword (true)
  let qari             // audio recitation qari's id
  let qariurl          // user-provided audio recitation base_url
  let teacher          // teacher mode (audio recitation before ayah): t/teach/teacher (true); n/noteach/noteacher (false; default)
  let disableteacher   // remove teacher mode selector from the UI, teacher mode can still be set from the URL: dt/disableteacher
  let disablequizmode  // remove quiz mode selector from the UI, quiz mode can still be set from the URL: dq/disablequizmode
  let zz               // enable embedded integration: zz (cannot be disabled if enabled)
  params
    .slice(1)  // remove the first character (`?` or `#`)
    .split('&')
    .map(p => p.split('='))
    //.reduce((obj, cur, i) => { i == 0? {} : (obj[cur[0]] = cur[1], obj), {})
    .forEach((e, i) => {
      const is_of = (...params) => params.includes(e[0])
           if (is_of('dark', 'd')) { dark = true  }
      else if (is_of('light', 'l')) { dark = false }
      else if (is_of('color', 'c')) { color = parse_color(e[1]) }
      else if (is_of('mvbtns', 'mv', 'm')) { mv = parse_mv(e[1]) }
      else if (is_of('quizmode', 'qz', 'q')) { quizmode = parse_quizmode(e[1]) }
      else if (is_of('byword')) { byword = true }
      else if (is_of('byletter')) { byword = false }
      else if (is_of('t', 'teach', 'teacher')) { teacher = true }
      else if (is_of('n', 'noteach', 'noteacher')) { teacher = false }
      else if (is_of('dt', 'disableteacher')) { disableteacher = true }
      else if (is_of('dq', 'disablequizmode')) { disablequizmode = true }
      else if (is_of('qari')) { qari = e[1] }
      else if (is_of('qariurl')) { qariurl = e[1] }
      else if (is_of('zz')) { zz = true }
      else if (is_of('a')) { a = +e[1] }
      else if (is_of('b')) { b = +e[1] }
      else if (is_of('p')) { [st, en] = pages_to_ayat(...range_to_pair(e[1])) }
      else if (is_of('s')) { [st, en] = suras_to_ayat(...range_to_pair(e[1])) }
      else if (is_of('r')) { [st, en] =  rubs_to_ayat(...range_to_pair(e[1])) }
      else if (is_of('h')) { [st, en] = hizbs_to_ayat(...range_to_pair(e[1])) }
      else if (is_of('j')) { [st, en] =  juzs_to_ayat(...range_to_pair(e[1])) }
      else if (is_of('k')) { [st, en] = rukus_to_ayat(...range_to_pair(e[1])) }
      else                 { [st, en] =  ayat_to_ayat(...range_to_pair(e[0])) }
    })
  let opts = { st:null, en:null, dark, color, mv, quizmode, disablequizmode, byword, qari, qariurl, teacher, disableteacher, zz }
  if (st == null || en == null) { return opts }
  st -= b; en += a
  if (st <= 0)    { st = 1    }
  if (en >  6236) { en = 6236 }
  opts = {...opts, st, en}
  return opts
}

function ligilumi () {
  const opts = _ligilumilo(window.location.hash || window.location.search)
  //
  opts.quizmode = opts.quizmode != null? opts.quizmode : Qid('quizmode').value
  Qid('quizmode').value = opts.quizmode
  //
  Qid('darkmode_input').checked = opts.dark
  delete opts.dark
  //
  Qid('teacher_input').checked = opts.teacher
  //
  Qid('qaris').value = opts.qari
  if (!Qid('qaris').value) { Qid('qaris').value = '' }  // if unset or is a bad value
  //
  if (opts.qariurl) { Qid('qaris').value = '_' }  // an invalid value to hide "With audio"
  Qid('qariurl').value = opts.qariurl
  //
  Qid('textclr_input').value = opts.color
  delete opts.color
  //
  Qid('mvbtns_input').value = opts.mv
  delete opts.mv
  //
  Qid('feedbackrate').value = opts.byword? 'word' : ''
  delete opts.byword
  //
  const hide = (e) => e.style.display = 'none'
  //
  if (opts.disableteacher) { hide(Qid('teacher_option')) }
  delete opts.disableteacher
  //
  if (opts.disablequizmode) {
    hide(Qid('quizmode_option'))
    Qall('.mode_options_title').forEach(hide)
  }
  delete opts.disablequizmode
  //
  chstyle()  // dark, color, mv
  chfeedbackrate()  // byword
  chquizmode()  // quizmode
  // if no aayat are selected, only change the provided preferences
  if (opts.st == null || opts.en == null) { return }
  recite(opts)
}

// vim: set sw=2 ts=2 et fdm=marker colorcolumn=80:



// remove the '#' in the previous line to perform the tests

let opts = {}

function start_reciting () {
  if (!valid_inputs(sura_bgn_val(), aaya_bgn_val(), sura_end_val(), aaya_end_val())) { return }
  const st = start_(sura_bgn_val()) + aaya_bgn_val()
  const en = start_(sura_end_val()) + aaya_end_val()
  const teacher = el_teacher_input.checked
  const qari = el_qaris.value
  const qariurl = el_qariurl.value
  const quizmode = el_quizmode.value
  hide_selectors(quizmode)
  opts = {...opts, st, en, qari, qariurl, teacher, quizmode}
  recite(opts)
}

function restart_reciting () {
  // qari and quizmode and teacher can change from the UI.
  opts.qari = el_qaris.value
  opts.quizmode = el_quizmode.value
  opts.teacher = el_teacher_input.checked
  hide_selectors(opts.quizmode)  // handles the change of quiz mode
  recite(opts)
}

function input_trigger_x (ev) {
  // this fn is connected to onkeyup and onmouseup. it handles three "events"

  const on_ayat = ev.target.id === 'aaya_bgn' || ev.target.id === 'aaya_end'
  const on_suar = ev.target.id === 'sura_bgn' || ev.target.id === 'sura_end'

  // Enter on suar/ayat selection: set focus on the next element:
  //   sura_bgn > aaya_bgn > sura_end > aaya_end > ok
  // also, on the last element, get the next (ie first) word
  if (ev.key === 'Enter' && (on_ayat || on_suar)) {
    (ev.target.id === 'sura_bgn'? el_aaya_bgn :
     ev.target.id === 'aaya_bgn'? el_sura_end :
     ev.target.id === 'sura_end'? el_aaya_end :
     ev.target.id === 'aaya_end'? el_ok       :
     1).focus()
    return
  }

  // Up or Down on an ayat-input, increase or decrease it
  if (on_ayat) {
    let el = Qid(ev.target.id)
    if (ev.key === 'ArrowUp')   { el.value = 1 + +defilter_aaya_input(el.value) }
    if (ev.key === 'ArrowDown') { el.value = 1 - +defilter_aaya_input(el.value) }
    validate_aaya_sura_input(ev)  // handles the filtering and the limits
    return
  }
}

function show_done () {
  if (el_endmsg.hidden) {
    el_endmsg.hidden = false
    confetti.start(1200, 50, 150)
    if (el_zzback.hidden) {  /* not zz-mode */
      show_selectors()
      setTimeout(() => el_ok.focus(), 500)
    }
    else {  /* zz-mode */
      el_mvbtns.hidden = true
      setTimeout(() => el_zzback.focus(), 500)
    }
    if (!el_imla_txt.hidden) {
      el_imla_txt.style.height = el_zzback.hidden? 'calc(100vh - 12rem)' : 'calc(100vh - 15rem)'
      el_imla_txt.scroll({ top: el_imla_txt.scrollHeight })  // scroll to bottom
    }
    return true
  }
  return false
}

function help_toggled () {
  setTimeout(scroll_to_top, 100)
}
function option_toggled () {
  // TODO: scroll to top of options
}

function scroll_to_top ()    { el_body.scrollTo({ top: 0 }) }
function scroll_to_bottom () { el_body.scrollTo({ top: el_body.scrollHeight }) }

function hide_el (el) { el.style.visibility = 'hidden';  el.style.opacity =   '0%' }
function show_el (el) { el.style.visibility = 'visible'; el.style.opacity = '100%' }

function sync_ui (stpair, enpair, title, preserve_url) {
  if (!preserve_url) { window.location.hash = stpair.join('/') + '-' + enpair.join('/') }
  document.querySelector('title').innerHTML = title + ' | رسايت'
  if (!el_zzignore.hidden) { parent.zz_set_title(title) }
  //
  el_sura_bgn.value = stpair[0]-1; el_aaya_bgn.value = filter_aaya_input(stpair[1])
  el_sura_end.value = enpair[0]-1; el_aaya_end.value = filter_aaya_input(enpair[1])
}

function init_audio (stpair, enpair, qari, qariurl) {
  audio.init(qari, qariurl)
  audio.fill(make_audio_list(stpair[0]-1, stpair[1], enpair[0]-1, enpair[1]))
}

function recite (o) {
  opts = o

  const preserve_url = !!window.location.search || !!window.location.hash

  el_zzback.style.display = o.zz? 'block' : 'none'
  el_zzback.hidden = !o.zz
  el_zzignore.hidden = !o.zz
  el_new.hidden = !!o.zz  // only hide if ignore is shown

  const stpair = idx2aya(o.st-1)
  const enpair = idx2aya(o.en-1)
  const [title, titleclass] = make_title(...stpair, ...enpair)
  el_title.innerHTML = title
  el_title.classList = titleclass
  sync_ui(stpair, enpair, title, preserve_url)
  init_audio(stpair, enpair, o.qari, o.qariurl, preserve_url)

  if (o.zz) { parent.zz_show() }
  hide_selectors(o.quizmode)

  const start = () => { _recite(o) }
  if (o.quizmode === 'imla') { load_imla(start) }
  else {  /* uthmani, which is split into two parts */
    const n1 = is_in_first_half(o.st, o.en)
    const n2 = is_in_second_half(o.st, o.en)
    if (n1 && n2) { load_uthm1(() => { load_uthm2(start) }) }  // TODO: parallize
    else if (n1) { load_uthm1(start) }
    else if (n2) { load_uthm2(start) }
  }
}

function _recite (o) {

  document.addEventListener('keyup', (ev) => {
    if (ev.key === 'Escape') {
      audio.play()
      if (o.quizmode === 'imla') {
        // re-focus, b/c Escape unfocuses it
        el_imla_txt.focus()
      }
    }
  })

  if (o.quizmode === 'imla') {
    el_imla_txt.focus()
    let correct_text = imlaai_ayat(o.st, o.en)
    let pasted = false

    const get_current_aaya_index = () =>
      el_imla_txt.value.split('\n').length - 2 + (o.teacher? 1 : 0)

    const txt_changed = function () {

      if (!el_endmsg.hidden) { return }

      if (pasted) {
        el_imla_txt.value = el_imla_txt.value.replace(/ \u06dd/g, '\xa0\u06dd')
        // because NBSP is copied as a normal, ASCII space
        pasted = false
      }

      if (correct_text.startsWith(imlafilter(el_imla_txt.value))) {
        el_imla_txt.classList = ''
        if (el_imla_txt.value.slice(-1) === '\n') {  // basmala, or BS+Enter to repeat the same aaya
          audio.play(get_current_aaya_index())
        }
      }

      else if (el_imla_txt.value.slice(-1) === '\n'
          && correct_text.startsWith(el_imla_txt.value.slice(0,-1) + '\xA0\u06dd'))
      {
        let x = el_imla_txt.value.length + 2
        while (correct_text.slice(x, x+1) !== '\n') { ++x }
        el_imla_txt.value = correct_text.slice(0, x+1)
        audio.play(get_current_aaya_index())
        if (el_imla_txt.value === correct_text) {
          el_imla_txt.value = el_imla_txt.value.slice(0,-1)  // remove the last newline
          show_done()
          scroll_to_bottom()
          el_imla_txt.disabled = true
          el_imla_txt.classList = 'done'
          el_new.focus()
        }
      }

      else {
        el_imla_txt.classList = 'wrong'
      }
    }

    el_imla_txt.oninput = txt_changed // https://stackoverflow.com/a/14029861
    el_imla_txt.onpaste = (e) => { pasted = true }
    el_imla_txt.focus()

    // these are set in Uthmani; need to override if used Uthmani before Imlaai
    document.onkeyup = () => {}
    document.ondblclick = () => {}

  }
  else {
    el_uthm_txt.focus()
    audio.set_index(o.teacher? 0 : -1)

    let words = make_words_list(o.st, o.en)

    const fwd = function (kind) {
      if (words.length === 0) { return }
      const isnt_the_kind =
        kind === 'a'? (k) => k !== 'a' :
        kind === 'j'? (k) => k !== 'a' && k !== 'j' :
                      (k) => false
      let new_word_kind, txt = ''
      do {
        let new_word = words.shift()
        txt += new_word
        new_word_kind = kind_of_portion( new_word.slice(-2) )
      } while (isnt_the_kind(new_word_kind))
      if (new_word_kind === 'a') { audio.next(); audio.play() }
      el_uthm_txt.innerHTML += txt
      if (words.length === 0) { show_done() }
      scroll_to_bottom()
    }

    const word_fwd = () => fwd('w')
    const aaya_fwd = () => fwd('a')
    const jmla_fwd = () => fwd('j')

    const word_bck = function (ev) {
      if (el_uthm_txt.innerHTML.length === 0) { return 'a' }
      if (!el_endmsg.hidden) { return 'a' }
      const last_word = el_uthm_txt.innerHTML.match(/(?:^|\t|<br>\n)([^\n\t]+(?:\t|<br>\n))$/)[1]
      words.unshift(last_word)
      el_uthm_txt.innerHTML = el_uthm_txt.innerHTML.substring(0, el_uthm_txt.innerHTML.length - last_word.length)
      if (last_word.match(/<br>\n$/)) {
        audio.back()
        if (o.teacher) { audio.play() }
      }
      return kind_of_portion( el_uthm_txt.innerHTML.slice(-2) )
    }

    const aaya_bck = function (ev) {
      do { var c = word_bck() } while (c !== 'a')
    }

    const jmla_bck = function (ev) {
      do { var c = word_bck() } while (c !== 'a' && c !== 'j')
    }

    const input_trigger = function (ev) {

      const kb_mod = ev.shiftKey || ev.ctrlKey || ev.altKey
      const kb_fwd = ev.key === ' ' || ev.key === 'Enter' || ev.key === 'ArrowLeft'
      const kb_bck = ev.key === 'Backspace' || ev.key === 'ArrowRight'
      const on_input_field =  // not just ayat and suar; also buttons like #mvbtns
        ev.target.nodeName === 'INPUT' || ev.target.nodeName === 'SELECT' || ev.target.nodeName === 'BUTTON'

      if (on_input_field) { return }

      if      (kb_fwd) { if (kb_mod) { aaya_fwd() } else { word_fwd() } }
      else if (kb_bck) { if (kb_mod) { aaya_bck() } else { word_bck() } }
      else if (ev.key === '0' && !kb_mod) { jmla_fwd() }
      else if (ev.key === '1' && !kb_mod) { jmla_bck() }

    }

    // both events are the "up" variants to disable repeating (holding down
    // the key, even for a few additional milliseconds by accident), which
    // prints a lot of words
    document.onkeyup = input_trigger
    document.ondblclick = (ev) => { if (ev.target === el_uthm_txt || ev.target === Qid('body')) { word_fwd() } }
    el_nextaaya.onclick = aaya_fwd
    el_nextjmla.onclick = jmla_fwd
    el_nextword.onclick = word_fwd
    el_prevword.onclick = word_bck
    el_prevjmla.onclick = jmla_bck
    el_prevaaya.onclick = aaya_bck

  }

  if (o.teacher) { audio.play(0) }
}

el_ok.onclick  = start_reciting

el_repeat.onmouseup = restart_reciting
el_repeat.onclick   = restart_reciting

function init_inputs () {
  el_sura_bgn.value   = el_aaya_bgn.value   = el_sura_end.value   = el_aaya_end.value   = ''
  el_sura_bgn.oninput = el_aaya_bgn.oninput = el_sura_end.oninput = el_aaya_end.oninput = validate_aaya_sura_input
  el_sura_bgn.onblur  = el_aaya_bgn.onblur  = el_sura_end.onblur  = el_aaya_end.onblur  = validate_aaya_sura_input
  el_sura_bgn.onkeyup = el_aaya_bgn.onkeyup = el_sura_end.onkeyup = el_aaya_end.onkeyup = input_trigger_x
}

const hide_selectors = function (quizmode) {
  el_selectors.hidden = true
  el_header.hidden = false
  el_endmsg.hidden = true
  el_ok.hidden = true
  el_title.style.display = 'inline-block'
  if (quizmode === 'imla') {
    el_imla_txt.style.height = '95vh'
    el_imla_txt.value = ""
    el_imla_txt.disabled = false
    el_imla_txt.classList = ''
    el_imla_txt.hidden = false
    el_uthm_txt.hidden = true
    el_mvbtns.hidden = true
    Qid('end_of_header').style.color = 'transparent'  // to keep some space
    document.documentElement.style.setProperty('--sticky', '')
    el_imla_txt.focus()
  }
  else {  /* uthmani */
    el_uthm_txt.hidden = false
    el_uthm_txt.innerHTML = ''
    el_mvbtns.hidden = false
    el_imla_txt.hidden = true
    Qid('end_of_header').style.color = ''
    document.documentElement.style.setProperty('--sticky', 'sticky')
    el_nextword.focus()
  }
  scroll_to_bottom()
}

const show_selectors = function () {
  el_selectors.hidden = false
  el_header.hidden = true
  el_ok.hidden = false
  el_mvbtns.hidden = true
  el_title.style.display = 'none'
  validate_aaya_sura_input({}) /* to enable #ok for easier repeating */
}

const clear_screen = function () {
  el_uthm_txt.innerHTML = ''
  el_imla_txt.hidden = true
  el_endmsg.hidden = true
}

const new_select = function () {
  show_selectors()
  clear_screen()
}

el_new.onmouseup = new_select
el_new.onclick   = new_select

el_zzback.onclick   = () => { clear_screen(); parent.zz_done()   }
el_zzignore.onclick = () => { clear_screen(); parent.zz_ignore() }

onload = function () {
  el_ok.disabled = true
  init_inputs()
  chquizmode()
  chstyle()  // to update the style, as we don't reset these
             // inputs, so they keep their values on refresh.
  decode_contact()
  ligilumi()
  el_imla_txt.spellcheck = false
  // fix help opening
  document.querySelectorAll('details').forEach(el => {
    el.addEventListener('toggle', ev => {
      if (el.open) {
        el.scrollIntoView({behavior: "smooth", block: "nearest", inline: "nearest"})
      }
    })
  })
}

// vim: set sw=2 ts=2 et fdm=marker colorcolumn=80:

function tajweed_colorize_aaya (a) {
  return a.replace(/([A-Z])<([^>]+)>/g, '<span_class="$1">$2</span>')
}

function make_audio_list (sura_bgn, aaya_bgn, sura_end, aaya_end) {
  // returns ayat ref in the form sprintf("%03d%03d", sura_num, aaya_num)
  return (
    [...Array(115).keys()].slice(+sura_bgn + 1, +sura_end + 2)
      // s is the sura number, 1-based
      .map(s => [...Array(+suar_length[s - 1] + 1).keys()]
        .slice(s === +sura_bgn + 1? +aaya_bgn     :   1,
               s === +sura_end + 1? +aaya_end + 1 : 300  // larger than any sura
        )
        .map(a => s.toString().padStart(3,'0')
                + a.toString().padStart(3,'0')
        )
      )
      .reduce((list, s) => {  // https://stackoverflow.com/a/38528645
        if (s[0].match(/001$/) &&  // if it's the first aaya of the sura
            !s[0].match(/^001/) && // and it's is not al-faatiha
            !s[0].match(/^009/)    // and it's is not at-tawba
        ) {
          s.unshift('001001')      // add basmala
        }
        list.push(...s)  // flatten
        return list
      }, [])
  )
}

function load_zip(basename, callback) {
  const filename = 'res/' + basename + '.zip'
  JSZipUtils.getBinaryContent(filename, function(err, data) {
    if (err) { throw err /* or handle err */ }
    JSZip.loadAsync(data).then(function (zip) {
      return zip.file(basename).async('string')
    }).then(function (str) {
      callback(str.split('\n'))
    })
  })
}

var imla
var uthm = Array(6236)

function load_imla (callback) {
  if (imla == null) {
    load_zip('imla', (arr) => { imla = arr; callback() })
  } else { callback() }
}

// uthmani is split into two parts: until Surat Mariam (Sura 19), and then from Surat Ta-Ha.
// this is *not* arbitrary: it makes both parts almost the same size in bytes.
const FIRST_AAYA_OF_TAHA = 2349
function is_in_first_half  (st, en) { return (st-1 <  FIRST_AAYA_OF_TAHA || en <  FIRST_AAYA_OF_TAHA) }
function is_in_second_half (st, en) { return (st-1 >= FIRST_AAYA_OF_TAHA || en >= FIRST_AAYA_OF_TAHA) }

/* WARNING: the files are named othm1 & othm2 NOT uthmN as you may expect; do NOT change this! */

function load_uthm1 (callback) {
  if (uthm[0] == null) {  /* checking an arbitrary aaya in the 1st half */
    load_zip('othm1', (arr) => { uthm = [...arr, ...uthm.slice(FIRST_AAYA_OF_TAHA)]; callback() })
  } else { callback() }
}

function load_uthm2 (callback) {
  if (uthm[6000] == null) {  /* checking an arbitrary aaya in the 2nd half */
    load_zip('othm2', (arr) => { uthm = [...uthm.slice(0,FIRST_AAYA_OF_TAHA-1), ...arr]; callback() })
  } else { callback() }
}

function imlaai_ayat (st, en) {

  return (
    imla
      .slice(st-1,en)
      .map(a => a.startsWith('#')? a.replace('#', 'بسم الله الرحمن الرحيم\n') : a)
      .join('\n')
      + '\n'
  )
}

function make_words_list (st, en) {

  // const st = +suar_length.slice(0, sura_bgn).reduce((a,b)=>a+b, 0) + +aaya_bgn
  // const en = +suar_length.slice(0, sura_end).reduce((a,b)=>a+b, 0) + +aaya_end

  // all spaces are a single space in html;
  // let's make tab ('\t') separates the words,
  // and newline (actually '<br>\n') separates the ayat.

  const basmala = 'بِسۡمِ ٱللَّهِ ٱX<ل>R<رَّ>حۡمَT<ـٰ>نِ ٱX<ل>R<رَّ>حِJ<ی>مِ A<۝>D<١>'  /*uothm[0] */
      .replace(/\xa0.*/, '').replace(/ /g, '\xa0')  // '\ufdfd'

  return (
    uthm
      .slice(st-1, en)
      .reduce((arr, aya) => {  // https://stackoverflow.com/a/38528645
        if (aya.startsWith('#')) {
          arr.push(basmala)
          aya = aya.replace('#', '')
        }
        arr.push(aya)
        return arr
      }, [])
      // for quran-data
      .map(a => a.replace(/أ\u064eو\u064e /g, 'أ\u064eو\u064e'))
      // continuing
      .map(a => tajweed_colorize_aaya(a))
      .map(a => a.replace(/ /g, '\t<SPC>') + '<br>\n')
      .map(a => a.replace(/_/g, ' '))  // for tajweed
      .reduce((arr, aya) => {
        arr.push(...aya.split('<SPC>', -1))  // split and flatten
        return arr
      }, [])
  )
}

// vim: set sw=2 ts=2 et fdm=marker colorcolumn=80:


</script>

</body>
</html>
<!-- vim: set sw=2 ts=2 et colorcolumn=80: -->
